{% extends "base.html" %}

{% block title %}Scanner de Placas - MRX Systems{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="row">
                <div class="col-lg-5 mb-4">
                    <div class="card shadow-lg h-100">
                        <div class="card-header bg-gradient-teal text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-microchip me-2"></i>
                                Scanner de PCB
                            </h4>
                            <p class="mb-0 mt-2 opacity-75">Analise placas com OpenCV + IA</p>
                        </div>
                        <div class="card-body">
                            <div id="scannerStatus" class="alert alert-info mb-4">
                                <i class="fas fa-info-circle me-2"></i>
                                Verificando status do scanner...
                            </div>
                            
                            <form id="scannerForm" enctype="multipart/form-data">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-camera me-2"></i>Imagem da Placa
                                    </label>
                                    <div class="upload-area" id="uploadArea">
                                        <input type="file" id="imageInput" name="image" accept="image/*" class="d-none">
                                        <div class="upload-placeholder" id="uploadPlaceholder">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <p class="mb-2">Arraste uma imagem ou clique para selecionar</p>
                                            <small class="text-muted">Formatos aceitos: JPG, PNG, WEBP</small>
                                        </div>
                                        <img id="imagePreview" class="img-fluid d-none" style="max-height: 300px; border-radius: 8px;">
                                    </div>
                                    <div class="mt-2 d-flex gap-2">
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="captureBtn">
                                            <i class="fas fa-camera me-1"></i> Usar Camera
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm d-none" id="clearImageBtn">
                                            <i class="fas fa-times me-1"></i> Limpar
                                        </button>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-teal btn-lg w-100" id="analyzeBtn" disabled>
                                    <i class="fas fa-search me-2"></i>Analisar Placa
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div id="resultCard" class="card shadow-lg mt-4 d-none">
                        <div class="card-header" id="resultHeader">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>
                                Resultado da Analise
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <div class="grade-badge" id="gradeBadge">
                                    <span id="gradeText">-</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Classificacao</p>
                            </div>
                            
                            <div class="result-stats mb-4">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="stat-box">
                                            <span class="stat-value" id="componentsCount">0</span>
                                            <span class="stat-label">Componentes</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-box">
                                            <span class="stat-value" id="confidenceText">0%</span>
                                            <span class="stat-label">Confianca</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6><i class="fas fa-microchip me-2"></i>Tipo Identificado</h6>
                                <p id="typeGuess" class="text-muted mb-0">-</p>
                            </div>
                            
                            <div class="explanation-box">
                                <h6><i class="fas fa-info-circle me-2"></i>Explicacao</h6>
                                <p id="explanation" class="mb-0">-</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="notDetectedCard" class="card shadow-lg mt-4 d-none">
                        <div class="card-body text-center py-5">
                            <div class="not-detected-icon">
                                <i class="fas fa-exclamation-triangle fa-4x text-warning"></i>
                            </div>
                            <h4 class="mt-4">Placa nao detectada</h4>
                            <p class="text-muted">Nao foi possivel identificar uma placa eletronica na imagem. Por favor, envie uma foto clara de uma PCB.</p>
                            <button class="btn btn-outline-primary" onclick="resetForm()">
                                <i class="fas fa-redo me-1"></i> Tentar Novamente
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-7">
                    <div id="historyCard" class="card shadow-lg">
                        <div class="card-header bg-gradient-dark text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>
                                Historico de Analises
                            </h5>
                            <span class="badge bg-light text-dark" id="historyCount">0</span>
                        </div>
                        <div class="card-body p-0">
                            <div id="historyList" class="history-list">
                                <div class="text-center py-5 text-muted">
                                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                    <p>Carregando historico...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="analysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Analise</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="closeModal()"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 text-center mb-3">
                        <img id="modalImage" src="" class="img-fluid rounded" style="max-height: 300px;">
                    </div>
                    <div class="col-md-6">
                        <div class="text-center mb-3">
                            <div class="grade-badge grade-badge-sm" id="modalGradeBadge">
                                <span id="modalGradeText">-</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>Tipo:</strong>
                            <p class="mb-0" id="modalType">-</p>
                        </div>
                        <div class="mb-3">
                            <strong>Componentes:</strong>
                            <span id="modalComponents">0</span>
                        </div>
                        <div class="mb-3">
                            <strong>Confianca:</strong>
                            <span id="modalConfidence">0%</span>
                        </div>
                        <div class="mb-3">
                            <strong>Data:</strong>
                            <span id="modalDate">-</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <strong>Explicacao:</strong>
                    <p id="modalExplanation" class="mt-2 p-3 bg-light rounded">-</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-teal {
    background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
}

.bg-gradient-dark {
    background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
}

.btn-teal {
    background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
    border: none;
    color: white;
}

.btn-teal:hover {
    background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%);
    color: white;
}

.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #fafafa;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.upload-area:hover {
    border-color: #0d9488;
    background: #f0fdfa;
}

.upload-area.dragover {
    border-color: #0d9488;
    background: #ccfbf1;
}

.grade-badge {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
}

.grade-badge-sm {
    width: 70px;
    height: 70px;
    font-size: 1.2rem;
}

.grade-badge.low { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
.grade-badge.medium { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
.grade-badge.high { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }

.stat-box {
    background: #f3f4f6;
    padding: 1rem;
    border-radius: 10px;
}

.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
}

.stat-label {
    font-size: 0.8rem;
    color: #6b7280;
    text-transform: uppercase;
}

.explanation-box {
    background: #f0fdfa;
    padding: 1rem;
    border-radius: 10px;
    border-left: 4px solid #0d9488;
}

.explanation-box p {
    color: #374151;
    line-height: 1.6;
}

.card {
    border: none;
    border-radius: 16px;
}

.card-header {
    border-radius: 16px 16px 0 0 !important;
}

.history-list {
    max-height: 600px;
    overflow-y: auto;
}

.history-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    cursor: pointer;
    transition: background 0.2s;
}

.history-item:hover {
    background: #f9fafb;
}

.history-item:last-child {
    border-bottom: none;
}

.history-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
    margin-right: 1rem;
    background: #e5e7eb;
}

.history-image-placeholder {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    background: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    color: #9ca3af;
}

.history-content {
    flex: 1;
}

.history-grade {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    color: white;
}

.history-grade.low { background: #ef4444; }
.history-grade.medium { background: #f59e0b; }
.history-grade.high { background: #10b981; }

.history-type {
    font-weight: 500;
    color: #111827;
    margin-bottom: 0.25rem;
}

.history-date {
    font-size: 0.8rem;
    color: #6b7280;
}

.history-explanation {
    font-size: 0.85rem;
    color: #6b7280;
    margin-top: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
}

.modal-dialog {
    max-width: 700px;
    margin: 1rem;
}

.modal-content {
    border-radius: 16px;
    border: none;
}

.empty-history {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
}

.empty-history i {
    font-size: 4rem;
    color: #d1d5db;
    margin-bottom: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const token = getToken();
    if (!token) {
        window.location.href = '/';
        return;
    }
    
    checkScannerStatus();
    loadHistory();
    setupUploadArea();
});

function checkScannerStatus() {
    fetch('/api/scanner/status')
        .then(r => r.json())
        .then(data => {
            const status = document.getElementById('scannerStatus');
            if (data.ready) {
                status.className = 'alert alert-success mb-4';
                status.innerHTML = '<i class="fas fa-check-circle me-2"></i>Scanner pronto para uso!';
            } else if (!data.enabled) {
                status.className = 'alert alert-warning mb-4';
                status.innerHTML = '<i class="fas fa-pause-circle me-2"></i>Scanner desativado pelo administrador.';
            }
        })
        .catch(err => {
            document.getElementById('scannerStatus').className = 'alert alert-danger mb-4';
            document.getElementById('scannerStatus').innerHTML = '<i class="fas fa-times-circle me-2"></i>Erro ao verificar status.';
        });
}

function setupUploadArea() {
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const clearBtn = document.getElementById('clearImageBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const captureBtn = document.getElementById('captureBtn');
    
    uploadArea.addEventListener('click', () => imageInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            imageInput.files = e.dataTransfer.files;
            handleImageSelect();
        }
    });
    
    imageInput.addEventListener('change', handleImageSelect);
    
    clearBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        resetForm();
    });
    
    captureBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            imageInput.setAttribute('capture', 'environment');
            imageInput.click();
        } else {
            alert('Camera nao disponivel neste dispositivo.');
        }
    });
    
    document.getElementById('scannerForm').addEventListener('submit', handleSubmit);
}

function handleImageSelect() {
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const clearBtn = document.getElementById('clearImageBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    
    if (imageInput.files && imageInput.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreview.classList.remove('d-none');
            uploadPlaceholder.classList.add('d-none');
            clearBtn.classList.remove('d-none');
            analyzeBtn.disabled = false;
        };
        reader.readAsDataURL(imageInput.files[0]);
    }
}

function resetForm() {
    document.getElementById('imageInput').value = '';
    document.getElementById('imagePreview').classList.add('d-none');
    document.getElementById('uploadPlaceholder').classList.remove('d-none');
    document.getElementById('clearImageBtn').classList.add('d-none');
    document.getElementById('analyzeBtn').disabled = true;
    document.getElementById('resultCard').classList.add('d-none');
    document.getElementById('notDetectedCard').classList.add('d-none');
}

async function handleSubmit(e) {
    e.preventDefault();
    
    const token = getToken();
    if (!token) {
        alert('Sessao expirada. Faca login novamente.');
        return;
    }
    
    const imageInput = document.getElementById('imageInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    
    if (!imageInput.files || !imageInput.files[0]) {
        alert('Selecione uma imagem da placa.');
        return;
    }
    
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analisando...';
    
    const formData = new FormData();
    formData.append('image', imageInput.files[0]);
    
    try {
        const response = await fetch('/api/scanner/analyze', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (data.board_detected === false) {
                document.getElementById('resultCard').classList.add('d-none');
                document.getElementById('notDetectedCard').classList.remove('d-none');
            } else {
                displayResult(data);
                loadHistory();
            }
        } else {
            alert(data.erro || 'Erro ao analisar imagem.');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="fas fa-search me-2"></i>Analisar Placa';
    }
}

function displayResult(data) {
    const resultCard = document.getElementById('resultCard');
    const gradeBadge = document.getElementById('gradeBadge');
    const gradeText = document.getElementById('gradeText');
    const resultHeader = document.getElementById('resultHeader');
    
    document.getElementById('notDetectedCard').classList.add('d-none');
    resultCard.classList.remove('d-none');
    
    const gradeClass = (data.grade || 'medium').toLowerCase();
    gradeBadge.className = 'grade-badge ' + gradeClass;
    gradeText.textContent = data.grade || '-';
    
    const gradeColors = {
        'LOW': '#ef4444',
        'MEDIUM': '#f59e0b',
        'HIGH': '#10b981'
    };
    resultHeader.style.background = gradeColors[data.grade] || gradeColors['MEDIUM'];
    resultHeader.style.color = '#fff';
    
    document.getElementById('typeGuess').textContent = data.type_guess || 'Nao identificado';
    document.getElementById('explanation').textContent = data.explanation || 'Sem explicacao disponivel';
    document.getElementById('componentsCount').textContent = data.components_count || 0;
    
    const confidence = Math.round((data.confidence || 0) * 100);
    document.getElementById('confidenceText').textContent = confidence + '%';
    
    resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

async function loadHistory() {
    const token = getToken();
    if (!token) return;
    
    try {
        const response = await fetch('/api/scanner/history?limit=20&include_images=true', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            const historyList = document.getElementById('historyList');
            document.getElementById('historyCount').textContent = data.length;
            
            if (data.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <i class="fas fa-camera"></i>
                        <h5>Nenhuma analise ainda</h5>
                        <p>Envie uma foto de uma placa para comecar</p>
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = data.map(item => {
                const gradeClass = (item.grade || 'medium').toLowerCase();
                const imageHtml = item.has_image ? 
                    `<img src="/api/scanner/analysis/${item.id}/image" class="history-image" alt="PCB">` :
                    `<div class="history-image-placeholder"><i class="fas fa-microchip"></i></div>`;
                
                return `
                    <div class="history-item" onclick="openAnalysisModal(${item.id})">
                        ${imageHtml}
                        <div class="history-content">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <span class="history-grade ${gradeClass}">${item.grade || '-'}</span>
                                <span class="history-date">${new Date(item.created_at).toLocaleString('pt-BR')}</span>
                            </div>
                            <div class="history-type">${item.type_guess || 'Tipo nao identificado'}</div>
                            <div class="history-explanation">${item.explanation || ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Erro ao carregar historico:', error);
    }
}

async function openAnalysisModal(analysisId) {
    const token = getToken();
    if (!token) return;
    
    try {
        const response = await fetch(`/api/scanner/analysis/${analysisId}?include_image=true`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.image_base64) {
                document.getElementById('modalImage').src = `data:${data.image_mimetype || 'image/jpeg'};base64,${data.image_base64}`;
            } else {
                document.getElementById('modalImage').src = '';
            }
            
            const gradeClass = (data.grade || 'medium').toLowerCase();
            document.getElementById('modalGradeBadge').className = 'grade-badge grade-badge-sm ' + gradeClass;
            document.getElementById('modalGradeText').textContent = data.grade || '-';
            document.getElementById('modalType').textContent = data.type_guess || 'Nao identificado';
            document.getElementById('modalComponents').textContent = data.components_count || 0;
            document.getElementById('modalConfidence').textContent = Math.round((data.confidence || 0) * 100) + '%';
            document.getElementById('modalDate').textContent = new Date(data.created_at).toLocaleString('pt-BR');
            document.getElementById('modalExplanation').textContent = data.explanation || 'Sem explicacao disponivel';
            
            document.getElementById('analysisModal').classList.add('show');
        }
    } catch (error) {
        console.error('Erro ao abrir analise:', error);
    }
}

function closeModal() {
    document.getElementById('analysisModal').classList.remove('show');
}

document.getElementById('analysisModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}
