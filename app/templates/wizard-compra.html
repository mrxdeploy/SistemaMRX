<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Compra - MRX Systems</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .wizard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e5e7eb;
            z-index: 0;
        }
        
        .wizard-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e5e7eb;
            color: #6b7280;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .wizard-step.active .step-number {
            background: #059669;
            border-color: #059669;
            color: white;
        }
        
        .wizard-step.completed .step-number {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }
        
        .step-label {
            font-size: 0.75rem;
            color: #6b7280;
            display: block;
        }
        
        .wizard-step.active .step-label {
            color: #059669;
            font-weight: 600;
        }
        
        .wizard-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            min-height: 500px;
        }
        
        .step-section {
            display: none;
        }
        
        .step-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fornecedor-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .fornecedor-card:hover {
            border-color: #059669;
            background: #f0fdf4;
        }
        
        .fornecedor-card.selected {
            border-color: #059669;
            background: #f0fdf4;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }
        
        .tabela-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .tabela-badge.estrelas-1 {
            background: #d1fae5;
            color: #065f46;
        }
        
        .tabela-badge.estrelas-2 {
            background: #fed7aa;
            color: #92400e;
        }
        
        .tabela-badge.estrelas-3 {
            background: #fecaca;
            color: #991b1b;
        }
        
        .cadastro-rapido {
            background: #f0f9ff;
            border: 2px dashed #3b82f6;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 1rem;
        }
        
        .material-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .material-item.alerta {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }
        
        .material-item.ok {
            border-left: 4px solid #10b981;
            background: #f0fdf4;
        }
        
        .btn-wizard {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .resumo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .resumo-card {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .resumo-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .resumo-valor {
            font-size: 1.75rem;
            font-weight: 700;
            color: #059669;
        }
        
        .gps-info {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content" style="justify-content: space-between;">
            <div class="logo">
                <img src="/static/images/mrx-logo.png" alt="MRX">
                <span>Nova Compra</span>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="btn btn-secondary" onclick="window.history.back()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>
        </div>
    </header>

    <main class="wizard-container">
        <h1 style="margin-bottom: 2rem; font-size: 2rem;">Nova Compra - Wizard</h1>

        <div class="wizard-steps">
            <div class="wizard-step active" id="step-indicator-1">
                <div class="step-number">1</div>
                <span class="step-label">Fornecedor</span>
            </div>
            <div class="wizard-step" id="step-indicator-2">
                <div class="step-number">2</div>
                <span class="step-label">Coleta/Entrega</span>
            </div>
            <div class="wizard-step" id="step-indicator-3">
                <div class="step-number">3</div>
                <span class="step-label">Leitura de Peças</span>
            </div>
            <div class="wizard-step" id="step-indicator-4">
                <div class="step-number">4</div>
                <span class="step-label">Valores</span>
            </div>
            <div class="wizard-step" id="step-indicator-5">
                <div class="step-number">5</div>
                <span class="step-label">Resumo</span>
            </div>
        </div>

        <div class="wizard-content">
            <!-- PASSO 1: SELECIONAR/CADASTRAR FORNECEDOR -->
            <div class="step-section active" id="step-1">
                <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-building"></i> Passo 1: Selecionar ou Cadastrar Fornecedor</h2>
                
                <div class="form-group">
                    <label>Buscar Fornecedor por Nome, CPF ou CNPJ</label>
                    <input type="text" id="buscaFornecedor" placeholder="Digite para buscar..." oninput="buscarFornecedores()">
                </div>

                <div id="listaFornecedores" style="max-height: 300px; overflow-y: auto; margin-bottom: 1.5rem;">
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <i class="fas fa-search" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Digite para buscar fornecedores</p>
                    </div>
                </div>

                <div style="text-align: center; margin: 1.5rem 0;">
                    <button class="btn btn-primary" onclick="mostrarCadastroRapido()">
                        <i class="fas fa-plus-circle"></i> Cadastrar Novo Fornecedor
                    </button>
                </div>

                <div id="cadastroRapido" class="cadastro-rapido" style="display: none;">
                    <h3 style="margin: 0 0 1.5rem 0; color: #1e40af;">
                        <i class="fas fa-user-plus"></i> Cadastro Rápido de Fornecedor
                    </h3>
                    
                    <div class="form-group">
                        <label>Nome Social / Razão Social *</label>
                        <input type="text" id="novoNome" required>
                    </div>

                    <div class="form-group">
                        <label>Tipo de Pessoa *</label>
                        <select id="novoTipoPessoa" onchange="alterarTipoPessoa()">
                            <option value="cnpj">CNPJ (Pessoa Jurídica)</option>
                            <option value="cpf">CPF (Pessoa Física)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label id="labelDocumento">CNPJ *</label>
                        <input type="text" id="novoDocumento" placeholder="00.000.000/0000-00" required>
                    </div>

                    <div class="form-group">
                        <label>Telefone / WhatsApp *</label>
                        <input type="tel" id="novoTelefone" placeholder="(00) 00000-0000" required>
                    </div>

                    <h4 style="margin: 1.5rem 0 1rem 0; color: #374151;">Endereço Principal</h4>

                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem;">
                        <div class="form-group">
                            <label>Rua *</label>
                            <input type="text" id="novoRua" required>
                        </div>
                        <div class="form-group">
                            <label>Número *</label>
                            <input type="text" id="novoNumero" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Bairro *</label>
                        <input type="text" id="novoBairro" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 0.75rem;">
                        <div class="form-group">
                            <label>Cidade *</label>
                            <input type="text" id="novoCidade" required>
                        </div>
                        <div class="form-group">
                            <label>UF *</label>
                            <input type="text" id="novoUF" maxlength="2" required>
                        </div>
                        <div class="form-group">
                            <label>CEP *</label>
                            <input type="text" id="novoCEP" placeholder="00000-000" required>
                        </div>
                    </div>

                    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="margin: 0 0 0.75rem 0; font-weight: 600; color: #856404;">
                            <i class="fas fa-map-marker-alt"></i> Geolocalização
                        </p>
                        <button type="button" class="btn btn-warning" onclick="capturarGPS()">
                            <i class="fas fa-crosshairs"></i> Capturar Localização Automática (GPS)
                        </button>
                        <div id="gpsDisplay" style="display: none;" class="gps-info">
                            <p style="margin: 0;"><strong>Coordenadas capturadas:</strong></p>
                            <p style="margin: 0.25rem 0 0 0;"><i class="fas fa-check-circle"></i> Latitude: <span id="latDisplay"></span></p>
                            <p style="margin: 0.25rem 0 0 0;"><i class="fas fa-check-circle"></i> Longitude: <span id="lonDisplay"></span></p>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="cancelarCadastro()" style="flex: 1;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="button" class="btn btn-success" onclick="salvarFornecedor()" style="flex: 2;">
                            <i class="fas fa-save"></i> Salvar Fornecedor
                        </button>
                    </div>
                </div>

                <div style="margin-top: 2rem; display: flex; justify-content: flex-end;">
                    <button class="btn btn-primary btn-wizard" onclick="avancarPasso(2)" disabled id="btnAvancar1">
                        Próximo <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- PASSO 2: DADOS DE COLETA/ENTREGA -->
            <div class="step-section" id="step-2">
                <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-truck"></i> Passo 2: Dados de Coleta/Entrega</h2>
                
                <div class="card" style="background: #f9fafb; margin-bottom: 1.5rem; padding: 1.5rem;">
                    <h3 style="margin: 0 0 1rem 0;">Fornecedor Selecionado</h3>
                    <div id="fornecedorSelecionadoDisplay"></div>
                </div>

                <div class="form-group">
                    <label><strong>Endereço de Coleta</strong></label>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="enderecoOpcao" value="padrao" checked onchange="alterarOpcaoEndereco()">
                            <span style="margin-left: 0.5rem;">Usar endereço padrão do fornecedor</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="enderecoOpcao" value="outro" onchange="alterarOpcaoEndereco()">
                            <span style="margin-left: 0.5rem;">Cadastrar novo endereço para esta compra</span>
                        </label>
                    </div>
                </div>

                <div id="novoEnderecoColeta" style="display: none; background: #eff6ff; padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
                    <h4 style="margin: 0 0 1rem 0; color: #1e40af;">Novo Endereço de Coleta</h4>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem;">
                        <div class="form-group">
                            <label>Rua</label>
                            <input type="text" id="ruaColeta">
                        </div>
                        <div class="form-group">
                            <label>Número</label>
                            <input type="text" id="numeroColeta">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem;">
                        <div class="form-group">
                            <label>Cidade</label>
                            <input type="text" id="cidadeColeta">
                        </div>
                        <div class="form-group">
                            <label>UF</label>
                            <input type="text" id="ufColeta" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>CEP</label>
                            <input type="text" id="cepColeta">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>Tipo de Operação</strong></label>
                    <select id="tipoOperacao">
                        <option value="coleta">Coleta (MRX busca no fornecedor)</option>
                        <option value="entrega">Entrega (Fornecedor entrega na MRX)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Observações</label>
                    <textarea id="observacoesColeta" rows="3" placeholder="Observações sobre a coleta/entrega..."></textarea>
                </div>

                <div style="margin-top: 2rem; display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary btn-wizard" onclick="voltarPasso(1)">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-primary btn-wizard" onclick="avancarPasso(3)">
                        Próximo <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- PASSO 3: LEITURA DE PEÇAS -->
            <div class="step-section" id="step-3">
                <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-barcode"></i> Passo 3: Leitura de Peças</h2>
                
                <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0; font-weight: 600; color: #92400e;">
                        <i class="fas fa-info-circle"></i> Use o scanner para ler os códigos das peças
                    </p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #78350f;">
                        O sistema identificará automaticamente o tipo de material (Leve, Médio ou Pesado)
                    </p>
                </div>

                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label>Código do Scanner ou Manual</label>
                        <div style="display: flex; gap: 0.75rem;">
                            <input type="text" id="codigoScanner" placeholder="Escanear código de barras ou digitar..." style="flex: 1;" onkeypress="if(event.key=='Enter') processarLeitura()">
                            <button class="btn btn-primary" onclick="processarLeitura()">
                                <i class="fas fa-search"></i> Identificar
                            </button>
                        </div>
                    </div>

                    <div id="materialIdentificado" style="display: none; background: #f0fdf4; padding: 1rem; border-radius: 8px; border-left: 4px solid #10b981; margin: 1rem 0;">
                        <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #065f46;">
                            <i class="fas fa-check-circle"></i> Material Identificado
                        </p>
                        <p style="margin: 0; font-size: 0.875rem;"><strong>Descrição:</strong> <span id="descMaterial"></span></p>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem;"><strong>Classificação:</strong> <span id="classMaterial"></span></p>
                    </div>

                    <div class="form-group">
                        <label>Peso (kg)</label>
                        <input type="number" id="pesoLeitura" step="0.01" min="0.01" placeholder="0.00">
                    </div>

                    <button class="btn btn-success w-full" onclick="adicionarLeitura()">
                        <i class="fas fa-plus"></i> Adicionar à Compra
                    </button>
                </div>

                <h3 style="margin: 1.5rem 0 1rem 0;">Itens Lidos</h3>
                
                <div id="listaLeituras">
                    <div style="text-align: center; padding: 2rem; color: #6b7280; background: #f9fafb; border-radius: 8px;">
                        <i class="fas fa-inbox" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Nenhuma peça escaneada ainda</p>
                    </div>
                </div>

                <div class="resumo-grid">
                    <div class="resumo-card">
                        <div class="resumo-label">Quantidade de Leituras</div>
                        <div class="resumo-valor" id="qtdLeituras">0</div>
                    </div>
                    <div class="resumo-card">
                        <div class="resumo-label">Peso Total (kg)</div>
                        <div class="resumo-valor" id="pesoTotalParcial">0.00</div>
                    </div>
                </div>

                <div style="margin-top: 2rem; display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary btn-wizard" onclick="voltarPasso(2)">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-primary btn-wizard" onclick="avancarPasso(4)" disabled id="btnAvancar3">
                        Próximo <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- PASSO 4: VALORES E TABELA -->
            <div class="step-section" id="step-4">
                <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-calculator"></i> Passo 4: Valores e Tabela de Preços</h2>
                
                <div class="card" style="background: #eff6ff; margin-bottom: 1.5rem; padding: 1.5rem;">
                    <h3 style="margin: 0 0 0.5rem 0; color: #1e40af;">
                        <i class="fas fa-star"></i> Tabela Vigente
                    </h3>
                    <div id="tabelaVigenteDisplay"></div>
                </div>

                <div id="itensValoracao"></div>

                <div id="alertaAutorizacao" style="display: none; background: #fef2f2; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #ef4444; margin: 1.5rem 0;">
                    <p style="margin: 0; font-weight: 700; color: #991b1b; font-size: 1.1rem;">
                        <i class="fas fa-exclamation-triangle"></i> Atenção: Preço Acima da Tabela
                    </p>
                    <p style="margin: 0.75rem 0 0 0; color: #7f1d1d;">
                        <span id="qtdAcimaTabela">0</span> item(ns) com preço negociado acima da tabela. Será enviada solicitação de autorização para o administrador.
                    </p>
                </div>

                <div class="resumo-grid">
                    <div class="resumo-card">
                        <div class="resumo-label">Total de Itens</div>
                        <div class="resumo-valor" id="totalItensValoracao">0</div>
                    </div>
                    <div class="resumo-card">
                        <div class="resumo-label">Peso Total (kg)</div>
                        <div class="resumo-valor" id="pesoTotalValoracao">0.00</div>
                    </div>
                    <div class="resumo-card">
                        <div class="resumo-label">Valor Total</div>
                        <div class="resumo-valor" id="valorTotalCompra">R$ 0.00</div>
                    </div>
                </div>

                <div style="margin-top: 2rem; display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary btn-wizard" onclick="voltarPasso(3)">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-primary btn-wizard" onclick="avancarPasso(5)">
                        Revisar Compra <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- PASSO 5: RESUMO E CONFIRMAÇÃO -->
            <div class="step-section" id="step-5">
                <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-clipboard-check"></i> Passo 5: Resumo da Compra</h2>
                
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 style="margin: 0 0 1rem 0;"><i class="fas fa-building"></i> Fornecedor</h3>
                    <div id="resumoFornecedor"></div>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 style="margin: 0 0 1rem 0;"><i class="fas fa-truck"></i> Coleta/Entrega</h3>
                    <div id="resumoColeta"></div>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 style="margin: 0 0 1rem 0;"><i class="fas fa-boxes"></i> Materiais</h3>
                    <div id="resumoMateriais"></div>
                </div>

                <div class="resumo-grid">
                    <div class="resumo-card">
                        <div class="resumo-label">Total de Itens</div>
                        <div class="resumo-valor" id="resumoTotalItens">0</div>
                    </div>
                    <div class="resumo-card">
                        <div class="resumo-label">Peso Total (kg)</div>
                        <div class="resumo-valor" id="resumoPesoTotal">0.00</div>
                    </div>
                    <div class="resumo-card">
                        <div class="resumo-label">Valor Total</div>
                        <div class="resumo-valor" id="resumoValorTotal">R$ 0.00</div>
                    </div>
                    <div class="resumo-card">
                        <div class="resumo-label">Tipo</div>
                        <div class="resumo-valor" style="font-size: 1.25rem;" id="resumoTipo">-</div>
                    </div>
                </div>

                <div id="resumoAlerta" style="display: none; background: #fef3c7; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #f59e0b; margin: 1.5rem 0;">
                    <p style="margin: 0; font-weight: 600; color: #92400e;">
                        <i class="fas fa-info-circle"></i> Esta compra possui itens pendentes de aprovação
                    </p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #78350f;">
                        O lote será gerado, mas os itens com preço acima da tabela precisarão de aprovação do administrador antes de serem processados.
                    </p>
                </div>

                <div style="margin-top: 2rem; display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary btn-wizard" onclick="voltarPasso(4)">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-success btn-wizard" onclick="finalizarCompra()" id="btnFinalizar" style="font-size: 1.1rem; padding: 1rem 2.5rem;">
                        <i class="fas fa-check-circle"></i> Confirmar Compra e Gerar Lote
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="/static/js/app.js"></script>
    <script src="/static/js/chat-widget.js"></script>
    <script src="/static/js/scanner-widget.js"></script>
    <script src="/static/js/rbac.js"></script>
    <script>
        let passoAtual = 1;
        let fornecedorSelecionado = null;
        let gpsLatitude = null;
        let gpsLongitude = null;
        let leiturasPecas = [];
        let dadosCompra = {
            fornecedor_id: null,
            endereco_coleta: null,
            tipo_operacao: 'coleta',
            observacoes: '',
            materiais: []
        };

        async function carregarPagina() {
            const user = await verificarAuth();
            if (!user) return;

            if (typeof renderizarMenusMobile === 'function') {
                renderizarMenusMobile();
            }
        }

        function atualizarIndicadores(passo) {
            for (let i = 1; i <= 5; i++) {
                const indicator = document.getElementById(`step-indicator-${i}`);
                const section = document.getElementById(`step-${i}`);
                
                if (i < passo) {
                    indicator.classList.remove('active');
                    indicator.classList.add('completed');
                } else if (i === passo) {
                    indicator.classList.remove('completed');
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active', 'completed');
                }

                section.classList.toggle('active', i === passo);
            }
        }

        function avancarPasso(passo) {
            passoAtual = passo;
            atualizarIndicadores(passo);
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (passo === 2) prepararPasso2();
            if (passo === 3) prepararPasso3();
            if (passo === 4) prepararPasso4();
            if (passo === 5) prepararPasso5();
        }

        function voltarPasso(passo) {
            passoAtual = passo;
            atualizarIndicadores(passo);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function buscarFornecedores() {
            const busca = document.getElementById('buscaFornecedor').value;
            if (busca.length < 2) {
                document.getElementById('listaFornecedores').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <i class="fas fa-search" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Digite ao menos 2 caracteres</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetchAPI(`/fornecedores?busca=${encodeURIComponent(busca)}`);
                if (!response || !response.ok) return;
                const fornecedores = await response.json();
                renderizarFornecedores(fornecedores);
            } catch (error) {
                console.error('Erro ao buscar fornecedores:', error);
            }
        }

        function renderizarFornecedores(fornecedores) {
            const container = document.getElementById('listaFornecedores');
            
            if (fornecedores.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <i class="fas fa-inbox" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Nenhum fornecedor encontrado</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = fornecedores.map(f => `
                <div class="fornecedor-card ${fornecedorSelecionado?.id === f.id ? 'selected' : ''}" 
                     onclick="selecionarFornecedor(${f.id})">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0;">${f.nome}</h4>
                            <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">
                                ${f.cnpj || f.cpf || 'N/A'} • ${f.cidade || 'N/A'}/${f.estado || ''}
                            </p>
                        </div>
                        <span class="tabela-badge estrelas-${f.tabela_preco_nivel_estrelas || 1}">
                            ${f.tabela_preco_nivel_estrelas || 1}★
                        </span>
                    </div>
                </div>
            `).join('');
        }

        async function selecionarFornecedor(id) {
            try {
                const response = await fetchAPI(`/fornecedores/${id}`);
                if (!response || !response.ok) return;
                
                fornecedorSelecionado = await response.json();
                dadosCompra.fornecedor_id = id;
                
                document.querySelectorAll('.fornecedor-card').forEach(card => {
                    card.classList.remove('selected');
                });
                event.currentTarget.classList.add('selected');
                
                document.getElementById('btnAvancar1').disabled = false;
                mostrarMensagem('Fornecedor selecionado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao selecionar fornecedor:', error);
                mostrarMensagem('Erro ao selecionar fornecedor', 'error');
            }
        }

        function mostrarCadastroRapido() {
            document.getElementById('cadastroRapido').style.display = 'block';
            document.getElementById('cadastroRapido').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarCadastro() {
            document.getElementById('cadastroRapido').style.display = 'none';
            limparFormularioCadastro();
        }

        function alterarTipoPessoa() {
            const tipo = document.getElementById('novoTipoPessoa').value;
            const label = document.getElementById('labelDocumento');
            const input = document.getElementById('novoDocumento');
            
            if (tipo === 'cpf') {
                label.textContent = 'CPF *';
                input.placeholder = '000.000.000-00';
            } else {
                label.textContent = 'CNPJ *';
                input.placeholder = '00.000.000/0000-00';
            }
        }

        async function capturarGPS() {
            if (!navigator.geolocation) {
                mostrarMensagem('Geolocalização não suportada neste navegador', 'error');
                return;
            }

            mostrarMensagem('Capturando localização...', 'info');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    gpsLatitude = position.coords.latitude;
                    gpsLongitude = position.coords.longitude;
                    
                    document.getElementById('latDisplay').textContent = gpsLatitude.toFixed(6);
                    document.getElementById('lonDisplay').textContent = gpsLongitude.toFixed(6);
                    document.getElementById('gpsDisplay').style.display = 'block';
                    
                    mostrarMensagem('Localização capturada com sucesso!', 'success');
                },
                (error) => {
                    console.error('Erro ao capturar GPS:', error);
                    mostrarMensagem('Erro ao capturar localização. Verifique as permissões.', 'error');
                }
            );
        }

        async function salvarFornecedor() {
            const dados = {
                nome: document.getElementById('novoNome').value,
                tipo_pessoa: document.getElementById('novoTipoPessoa').value,
                cnpj: document.getElementById('novoTipoPessoa').value === 'cnpj' ? document.getElementById('novoDocumento').value : null,
                cpf: document.getElementById('novoTipoPessoa').value === 'cpf' ? document.getElementById('novoDocumento').value : null,
                telefone: document.getElementById('novoTelefone').value,
                rua: document.getElementById('novoRua').value,
                numero: document.getElementById('novoNumero').value,
                bairro: document.getElementById('novoBairro').value,
                cidade: document.getElementById('novoCidade').value,
                estado: document.getElementById('novoUF').value,
                cep: document.getElementById('novoCEP').value,
                latitude: gpsLatitude,
                longitude: gpsLongitude
            };

            if (!dados.nome || !dados.telefone || !dados.rua || !dados.cidade) {
                mostrarMensagem('Preencha todos os campos obrigatórios', 'error');
                return;
            }

            if (!gpsLatitude || !gpsLongitude) {
                if (!confirm('Geolocalização não capturada. Deseja continuar mesmo assim?')) {
                    return;
                }
            }

            try {
                const response = await fetchAPI('/fornecedores', {
                    method: 'POST',
                    body: JSON.stringify(dados)
                });

                if (!response || !response.ok) {
                    const erro = await response.json();
                    throw new Error(erro.erro || 'Erro ao criar fornecedor');
                }

                const novoFornecedor = await response.json();
                mostrarMensagem('Fornecedor cadastrado com sucesso!', 'success');
                
                fornecedorSelecionado = novoFornecedor;
                dadosCompra.fornecedor_id = novoFornecedor.id;
                
                cancelarCadastro();
                document.getElementById('btnAvancar1').disabled = false;
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem(error.message || 'Erro ao salvar fornecedor', 'error');
            }
        }

        function limparFormularioCadastro() {
            document.getElementById('novoNome').value = '';
            document.getElementById('novoDocumento').value = '';
            document.getElementById('novoTelefone').value = '';
            document.getElementById('novoRua').value = '';
            document.getElementById('novoNumero').value = '';
            document.getElementById('novoBairro').value = '';
            document.getElementById('novoCidade').value = '';
            document.getElementById('novoUF').value = '';
            document.getElementById('novoCEP').value = '';
            document.getElementById('gpsDisplay').style.display = 'none';
            gpsLatitude = null;
            gpsLongitude = null;
        }

        function prepararPasso2() {
            if (!fornecedorSelecionado) return;

            document.getElementById('fornecedorSelecionadoDisplay').innerHTML = `
                <p style="margin: 0;"><strong>Nome:</strong> ${fornecedorSelecionado.nome}</p>
                <p style="margin: 0.5rem 0 0 0;"><strong>Endereço:</strong> ${fornecedorSelecionado.rua || ''}, ${fornecedorSelecionado.numero || ''} - ${fornecedorSelecionado.cidade || ''}/${fornecedorSelecionado.estado || ''}</p>
                <p style="margin: 0.5rem 0 0 0;"><strong>Tabela:</strong> <span class="tabela-badge estrelas-${fornecedorSelecionado.tabela_preco_nivel_estrelas || 1}">${fornecedorSelecionado.tabela_preco_nivel_estrelas || 1}★</span></p>
            `;
        }

        function alterarOpcaoEndereco() {
            const opcao = document.querySelector('input[name="enderecoOpcao"]:checked').value;
            document.getElementById('novoEnderecoColeta').style.display = opcao === 'outro' ? 'block' : 'none';
        }

        function prepararPasso3() {
            dadosCompra.tipo_operacao = document.getElementById('tipoOperacao').value;
            dadosCompra.observacoes = document.getElementById('observacoesColeta').value;
            
            const opcaoEndereco = document.querySelector('input[name="enderecoOpcao"]:checked').value;
            if (opcaoEndereco === 'outro') {
                dadosCompra.endereco_coleta = {
                    rua: document.getElementById('ruaColeta').value,
                    numero: document.getElementById('numeroColeta').value,
                    cidade: document.getElementById('cidadeColeta').value,
                    uf: document.getElementById('ufColeta').value,
                    cep: document.getElementById('cepColeta').value
                };
            } else {
                dadosCompra.endereco_coleta = null;
            }
        }

        async function processarLeitura() {
            const codigo = document.getElementById('codigoScanner').value;
            if (!codigo) {
                mostrarMensagem('Digite ou escaneie um código', 'error');
                return;
            }

            document.getElementById('materialIdentificado').style.display = 'block';
            document.getElementById('descMaterial').textContent = `Material: ${codigo}`;
            
            const classificacoes = ['Leve', 'Médio', 'Pesado'];
            const classSorteada = classificacoes[Math.floor(Math.random() * 3)];
            document.getElementById('classMaterial').textContent = classSorteada;
        }

        function adicionarLeitura() {
            const codigo = document.getElementById('codigoScanner').value;
            const peso = parseFloat(document.getElementById('pesoLeitura').value);
            const classificacao = document.getElementById('classMaterial').textContent;

            if (!codigo || !peso || peso <= 0) {
                mostrarMensagem('Preencha o código e o peso', 'error');
                return;
            }

            const leitura = {
                codigo: codigo,
                classificacao: classificacao,
                peso_kg: peso,
                descricao: document.getElementById('descMaterial').textContent
            };

            leiturasPecas.push(leitura);
            renderizarLeituras();
            
            document.getElementById('codigoScanner').value = '';
            document.getElementById('pesoLeitura').value = '';
            document.getElementById('materialIdentificado').style.display = 'none';
            
            document.getElementById('btnAvancar3').disabled = false;
        }

        function renderizarLeituras() {
            const container = document.getElementById('listaLeituras');
            
            if (leiturasPecas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280; background: #f9fafb; border-radius: 8px;">
                        <i class="fas fa-inbox" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Nenhuma peça escaneada ainda</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = leiturasPecas.map((item, index) => `
                <div class="material-item ok">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <p style="margin: 0; font-weight: 600;">${item.descricao}</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #6b7280;">
                                <strong>Classificação:</strong> ${item.classificacao} • <strong>Peso:</strong> ${item.peso_kg.toFixed(2)} kg
                            </p>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="removerLeitura(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            const pesoTotal = leiturasPecas.reduce((sum, item) => sum + item.peso_kg, 0);
            document.getElementById('qtdLeituras').textContent = leiturasPecas.length;
            document.getElementById('pesoTotalParcial').textContent = pesoTotal.toFixed(2);
        }

        function removerLeitura(index) {
            leiturasPecas.splice(index, 1);
            renderizarLeituras();
            if (leiturasPecas.length === 0) {
                document.getElementById('btnAvancar3').disabled = true;
            }
        }

        function prepararPasso4() {
            if (!fornecedorSelecionado) return;

            const tabelaEstrelas = fornecedorSelecionado.tabela_preco_nivel_estrelas || 1;
            document.getElementById('tabelaVigenteDisplay').innerHTML = `
                <span class="tabela-badge estrelas-${tabelaEstrelas}" style="font-size: 1rem; padding: 0.5rem 1rem;">
                    <i class="fas fa-star"></i> Tabela ${tabelaEstrelas} Estrela(s)
                </span>
            `;

            const precosPorClassificacao = {
                'Leve': 5.00 * tabelaEstrelas,
                'Médio': 8.00 * tabelaEstrelas,
                'Pesado': 12.00 * tabelaEstrelas
            };

            let html = '<div style="margin-top: 1.5rem;">';
            leiturasPecas.forEach((item, index) => {
                const precoTabela = precosPorClassificacao[item.classificacao];
                html += `
                    <div class="material-item" style="margin-bottom: 1rem;">
                        <p style="margin: 0 0 0.75rem 0; font-weight: 600;">${item.descricao}</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.875rem;">Peso (kg)</label>
                                <input type="number" value="${item.peso_kg}" readonly style="background: #f3f4f6;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.875rem;">Preço Tabela (R$/kg)</label>
                                <input type="number" value="${precoTabela.toFixed(2)}" readonly style="background: #f3f4f6;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.875rem;">Preço Negociado (R$/kg)</label>
                                <input type="number" id="preco_${index}" value="${precoTabela.toFixed(2)}" step="0.01" min="0" onchange="calcularTotal()">
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('itensValoracao').innerHTML = html;
            
            calcularTotal();
        }

        function calcularTotal() {
            let totalItens = leiturasPecas.length;
            let pesoTotal = 0;
            let valorTotal = 0;
            let qtdAcima = 0;

            leiturasPecas.forEach((item, index) => {
                const precoNegociado = parseFloat(document.getElementById(`preco_${index}`).value) || 0;
                const valorItem = item.peso_kg * precoNegociado;
                
                pesoTotal += item.peso_kg;
                valorTotal += valorItem;
                
                item.preco_negociado = precoNegociado;
                item.valor_total = valorItem;
            });

            document.getElementById('totalItensValoracao').textContent = totalItens;
            document.getElementById('pesoTotalValoracao').textContent = pesoTotal.toFixed(2);
            document.getElementById('valorTotalCompra').textContent = `R$ ${valorTotal.toFixed(2)}`;
            
            document.getElementById('alertaAutorizacao').style.display = qtdAcima > 0 ? 'block' : 'none';
            document.getElementById('qtdAcimaTabela').textContent = qtdAcima;
        }

        function prepararPasso5() {
            if (!fornecedorSelecionado) return;

            document.getElementById('resumoFornecedor').innerHTML = `
                <p style="margin: 0;"><strong>Nome:</strong> ${fornecedorSelecionado.nome}</p>
                <p style="margin: 0.5rem 0 0 0;"><strong>CPF/CNPJ:</strong> ${fornecedorSelecionado.cnpj || fornecedorSelecionado.cpf || 'N/A'}</p>
                <p style="margin: 0.5rem 0 0 0;"><strong>Cidade:</strong> ${fornecedorSelecionado.cidade || 'N/A'}/${fornecedorSelecionado.estado || ''}</p>
                <p style="margin: 0.5rem 0 0 0;"><strong>Tabela:</strong> <span class="tabela-badge estrelas-${fornecedorSelecionado.tabela_preco_nivel_estrelas || 1}">${fornecedorSelecionado.tabela_preco_nivel_estrelas || 1}★</span></p>
            `;

            const tipoOp = dadosCompra.tipo_operacao === 'coleta' ? 'Coleta (MRX busca)' : 'Entrega (Fornecedor entrega)';
            document.getElementById('resumoColeta').innerHTML = `
                <p style="margin: 0;"><strong>Tipo:</strong> ${tipoOp}</p>
                ${dadosCompra.observacoes ? `<p style="margin: 0.5rem 0 0 0;"><strong>Observações:</strong> ${dadosCompra.observacoes}</p>` : ''}
            `;

            let htmlMateriais = '<div style="display: grid; gap: 0.75rem;">';
            let totalPeso = 0;
            let totalValor = 0;

            leiturasPecas.forEach(item => {
                totalPeso += item.peso_kg;
                totalValor += item.valor_total || 0;
                htmlMateriais += `
                    <div class="material-item ok">
                        <p style="margin: 0; font-weight: 600;">${item.descricao}</p>
                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                            <span><strong>Peso:</strong> ${item.peso_kg.toFixed(2)} kg</span>
                            <span><strong>Preço:</strong> R$ ${(item.preco_negociado || 0).toFixed(2)}/kg</span>
                            <span><strong>Total:</strong> R$ ${(item.valor_total || 0).toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });
            htmlMateriais += '</div>';
            document.getElementById('resumoMateriais').innerHTML = htmlMateriais;

            document.getElementById('resumoTotalItens').textContent = leiturasPecas.length;
            document.getElementById('resumoPesoTotal').textContent = totalPeso.toFixed(2);
            document.getElementById('resumoValorTotal').textContent = `R$ ${totalValor.toFixed(2)}`;
            document.getElementById('resumoTipo').textContent = tipoOp.split('(')[0].trim();
        }

        async function finalizarCompra() {
            if (!fornecedorSelecionado || leiturasPecas.length === 0) {
                mostrarMensagem('Dados incompletos', 'error');
                return;
            }

            const dados = {
                fornecedor_id: dadosCompra.fornecedor_id,
                tipo_operacao: dadosCompra.tipo_operacao,
                endereco_coleta: dadosCompra.endereco_coleta,
                observacoes: dadosCompra.observacoes,
                materiais: leiturasPecas
            };

            document.getElementById('btnFinalizar').disabled = true;
            document.getElementById('btnFinalizar').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

            try {
                const response = await fetchAPI('/compras', {
                    method: 'POST',
                    body: JSON.stringify(dados)
                });

                if (!response || !response.ok) {
                    const erro = await response.json();
                    throw new Error(erro.erro || 'Erro ao criar compra');
                }

                const resultado = await response.json();
                
                mostrarMensagem(`Compra finalizada com sucesso! Lote: ${resultado.lote_codigo}`, 'success');
                
                setTimeout(() => {
                    window.location.href = '/funcionario.html';
                }, 2000);
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem(error.message || 'Erro ao finalizar compra', 'error');
                document.getElementById('btnFinalizar').disabled = false;
                document.getElementById('btnFinalizar').innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Compra e Gerar Lote';
            }
        }

        function mostrarMensagem(mensagem, tipo) {
            alert(mensagem);
        }

        window.onload = carregarPagina;
    </script>
</body>
</html>
