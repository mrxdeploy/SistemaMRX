<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprovação de Resíduos - MRX Systems</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* Ajustes de espaçamento para header fixo e bottom nav */
        body {
            padding-bottom: 95px; /* Espaço para bottom nav */
        }

        main.container {
            padding-top: 80px; /* Espaço para header fixo */
            padding-bottom: 100px; /* Espaço para bottom nav */
        }

        /* Ajuste específico para o título no mobile */
        @media (max-width: 768px) {
            main.container h1 {
                margin-top: 25px !important;
                padding-top: 0;
            }
        }

        /* Ajustes específicos para desktop */
        @media (min-width: 1024px) {
            main.container {
                padding-top: 90px; /* Header um pouco maior no desktop */
                padding-bottom: 100px; /* Mantém espaço para bottom nav */
            }
        }

        /* Garantir que modais não sejam cortados */
        .modal {
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .modal.active {
            overflow-y: auto;
        }

        /* Ajuste para cards não ficarem atrás da navbar */
        .card {
            position: relative;
            z-index: 1;
        }

        /* Status badges */
        .status {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-aprovado {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejeitado {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body></body>
    <header>
        <div class="header-content" style="justify-content: space-between;">
            <div class="logo">
                <img src="/static/images/mrx-logo.png" alt="MRX">
                <span>Aprovação de Resíduos</span>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="notification-badge" onclick="window.location.href='/notificacoes.html'">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Sair</button>
            </div>
        </div>
    </header>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav" id="navMenuMobile">
        <!-- Menus serão renderizados dinamicamente pelo RBAC -->
    </nav>

    <main class="container">
        <h1 style="font-size: clamp(1.5rem, 6vw, 2rem); margin-bottom: 1.5rem; margin-top: 0;">Aprovação de Resíduos</h1>

        <!-- Filtro de Status -->
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="form-group" style="margin-bottom: 0;">
                <label>Status</label>
                <select id="filtroStatus" onchange="carregarResiduos()">
                    <option value="AGUARDANDO_APROVACAO">Aguardando Aprovação</option>
                    <option value="APROVADO">Aprovados</option>
                    <option value="REJEITADO">Rejeitados</option>
                </select>
            </div>
        </div>

        <!-- Estatísticas -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div class="card" style="text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: var(--warning-color);" id="statPendentes">0</div>
                <div style="color: var(--gray-600); font-size: 0.875rem;">Pendentes</div>
            </div>
            <div class="card" style="text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: var(--success-color);" id="statAprovados">0</div>
                <div style="color: var(--gray-600); font-size: 0.875rem;">Aprovados</div>
            </div>
            <div class="card" style="text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: var(--danger-color);" id="statRejeitados">0</div>
                <div style="color: var(--gray-600); font-size: 0.875rem;">Rejeitados</div>
            </div>
        </div>

        <!-- Lista de Resíduos -->
        <div id="listaResiduos" style="display: grid; gap: 1rem;">
            <div class="card" style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i>
                <p style="margin-top: 1rem; color: var(--gray-600);">Carregando resíduos...</p>
            </div>
        </div>
    </main>

    <!-- Modal de Aprovação/Rejeição -->
    <div class="modal" id="modalDecisao">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="tituloModal">Aprovar Resíduo</h2>
                <span class="modal-close" onclick="fecharModal()">&times;</span>
            </div>
            <div id="conteudoModal" style="padding: 1rem 0;">
                <div class="form-group">
                    <label>Motivo da Decisão (Opcional)</label>
                    <textarea id="motivoDecisao" rows="3" placeholder="Digite o motivo da aprovação ou rejeição..."></textarea>
                </div>
            </div>
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                <button class="btn" id="btnConfirmar" onclick="confirmarDecisao()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Fotos -->
    <div class="modal" id="modalFotos">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Fotos do Resíduo</h2>
                <span class="modal-close" onclick="document.getElementById('modalFotos').classList.remove('active')">&times;</span>
            </div>
            <div id="conteudoFotos" style="padding: 1rem 0; display: grid; gap: 1rem;"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/static/js/rbac.js"></script>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/chat-widget.js"></script>
    <script src="/static/js/scanner-widget.js"></script>
    <script>
        let residuos = [];
        let residuoAtual = null;
        let decisaoAtual = null;
        let usuarioAtual = null;

        async function carregarPagina() {
            const user = await verificarAuth();
            if (!user) return;

            usuarioAtual = user;
            if (user.tipo !== 'admin' && user.perfil_nome !== 'Administrador') {
                showAlert('Acesso restrito a administradores');
                window.location.href = '/';
                return;
            }

            await carregarResiduos();
            await carregarEstatisticas();
            await atualizarNotificacoes();
        }

        async function carregarResiduos() {
            try {
                const status = document.getElementById('filtroStatus').value;

                const response = await fetchAPI(`/separacao/residuos?status=${status}`);
                if (!response || !response.ok) return;

                residuos = await response.json();
                renderizarResiduos();
            } catch (error) {
                console.error('Erro ao carregar resíduos:', error);
                showAlert('Erro ao carregar resíduos', 'error');
            }
        }

        async function carregarEstatisticas() {
            try {
                const response = await fetchAPI('/separacao/estatisticas');
                if (!response || !response.ok) return;

                const stats = await response.json();

                document.getElementById('statPendentes').textContent = stats.residuos_pendentes || 0;
                document.getElementById('statAprovados').textContent = stats.residuos_aprovados || 0;
                document.getElementById('statRejeitados').textContent = stats.residuos_rejeitados || 0;
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        function renderizarResiduos() {
            const container = document.getElementById('listaResiduos');

            if (residuos.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 2rem;">
                        <i class="fas fa-inbox" style="font-size: 3rem; color: var(--gray-400);"></i>
                        <p style="margin-top: 1rem; color: var(--gray-600);">Nenhum resíduo encontrado</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = residuos.map(res => {
                const statusClass = {
                    'AGUARDANDO_APROVACAO': 'status-pendente',
                    'APROVADO': 'status-aprovado',
                    'REJEITADO': 'status-rejeitado'
                }[res.status] || '';

                const aguardandoAprovacao = res.status === 'AGUARDANDO_APROVACAO';

                return `
                    <div class="card" style="border-left: 4px solid ${
                        res.status === 'APROVADO' ? 'var(--success-color)' : 
                        res.status === 'REJEITADO' ? 'var(--danger-color)' : 
                        'var(--warning-color)'
                    };">
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <h3 style="margin: 0; font-size: 1.25rem;">${res.material}</h3>
                                    <p style="color: var(--gray-600); margin: 0.5rem 0 0 0;">
                                        Lote: ${res.lote_numero || 'N/A'} | Operador: ${res.operador_nome || 'N/A'}
                                    </p>
                                </div>
                                <span class="status ${statusClass}">${formatarStatus(res.status)}</span>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <p style="color: var(--gray-600); margin: 0; font-size: 0.875rem;">Peso</p>
                                    <p style="margin: 0.25rem 0 0 0; font-size: 1.25rem; font-weight: bold;">${res.peso?.toFixed(2) || 0} kg</p>
                                </div>
                                ${res.quantidade ? `
                                    <div>
                                        <p style="color: var(--gray-600); margin: 0; font-size: 0.875rem;">Quantidade</p>
                                        <p style="margin: 0.25rem 0 0 0; font-size: 1.25rem; font-weight: bold;">${res.quantidade}</p>
                                    </div>
                                ` : ''}
                                ${res.classificacao ? `
                                    <div>
                                        <p style="color: var(--gray-600); margin: 0; font-size: 0.875rem;">Classificação</p>
                                        <p style="margin: 0.25rem 0 0 0;">${res.classificacao}</p>
                                    </div>
                                ` : ''}
                                <div>
                                    <p style="color: var(--gray-600); margin: 0; font-size: 0.875rem;">Data</p>
                                    <p style="margin: 0.25rem 0 0 0;">${formatDate(res.criado_em)}</p>
                                </div>
                            </div>

                            ${res.justificativa ? `
                                <div style="background: var(--gray-100); padding: 0.75rem; border-radius: 8px;">
                                    <p style="margin: 0; color: var(--gray-600); font-size: 0.875rem; font-weight: bold;">Justificativa:</p>
                                    <p style="margin: 0.5rem 0 0 0;">${res.justificativa}</p>
                                </div>
                            ` : ''}

                            ${res.status !== 'AGUARDANDO_APROVACAO' && res.motivo_decisao ? `
                                <div style="background: ${res.status === 'APROVADO' ? 'var(--success-bg)' : 'var(--danger-bg)'}; padding: 0.75rem; border-radius: 8px;">
                                    <p style="margin: 0; color: var(--gray-600); font-size: 0.875rem; font-weight: bold;">Motivo da Decisão:</p>
                                    <p style="margin: 0.5rem 0 0 0;">${res.motivo_decisao}</p>
                                </div>
                            ` : ''}

                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                ${aguardandoAprovacao ? `
                                    <button class="btn btn-success" onclick="abrirModalDecisao(${res.id}, 'APROVAR')">
                                        <i class="fas fa-check"></i> Aprovar
                                    </button>
                                    <button class="btn btn-danger" onclick="abrirModalDecisao(${res.id}, 'REJEITAR')">
                                        <i class="fas fa-times"></i> Rejeitar
                                    </button>
                                ` : ''}
                                ${res.fotos && res.fotos.length > 0 ? `
                                    <button class="btn btn-secondary" onclick='verFotos(${JSON.stringify(res.fotos)})'>
                                        <i class="fas fa-camera"></i> Ver Fotos (${res.fotos.length})
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function abrirModalDecisao(id, decisao) {
            residuoAtual = residuos.find(r => r.id === id);
            decisaoAtual = decisao;

            const titulo = decisao === 'APROVAR' ? 'Aprovar Resíduo' : 'Rejeitar Resíduo';
            document.getElementById('tituloModal').textContent = titulo;

            const btnConfirmar = document.getElementById('btnConfirmar');
            btnConfirmar.className = decisao === 'APROVAR' ? 'btn btn-success' : 'btn btn-danger';
            btnConfirmar.textContent = decisao === 'APROVAR' ? 'Aprovar' : 'Rejeitar';

            document.getElementById('motivoDecisao').value = '';
            document.getElementById('modalDecisao').classList.add('active');
        }

        async function confirmarDecisao() {
            try {
                const motivo = document.getElementById('motivoDecisao').value.trim();

                const response = await fetchAPI(`/separacao/residuos/${residuoAtual.id}/aprovar-adm`, {
                    method: 'POST',
                    body: JSON.stringify({
                        decisao: decisaoAtual,
                        motivo: motivo
                    })
                });

                if (response && response.ok) {
                    const msg = decisaoAtual === 'APROVAR' ? 'Resíduo aprovado com sucesso!' : 'Resíduo rejeitado com sucesso!';
                    showAlert(msg, 'success');
                    fecharModal();
                    await carregarResiduos();
                    await carregarEstatisticas();
                } else {
                    const error = await response.json();
                    showAlert(error.erro || 'Erro ao processar decisão', 'error');
                }
            } catch (error) {
                console.error('Erro ao confirmar decisão:', error);
                showAlert('Erro ao processar decisão', 'error');
            }
        }

        function fecharModal() {
            document.getElementById('modalDecisao').classList.remove('active');
            residuoAtual = null;
            decisaoAtual = null;
        }

        function verFotos(fotos) {
            const container = document.getElementById('conteudoFotos');
            container.innerHTML = fotos.map(foto => `
                <img src="/${foto}" style="max-width: 100%; border-radius: 8px; cursor: pointer;" 
                     onclick="window.open('/${foto}', '_blank')">
            `).join('');
            document.getElementById('modalFotos').classList.add('active');
        }

        function formatarStatus(status) {
            const statusMap = {
                'AGUARDANDO_APROVACAO': 'Aguardando',
                'APROVADO': 'Aprovado',
                'REJEITADO': 'Rejeitado'
            };
            return statusMap[status] || status;
        }

        carregarPagina();

        // Atualizar a cada 30 segundos
        setInterval(() => {
            if (document.getElementById('filtroStatus').value === 'AGUARDANDO_APROVACAO') {
                carregarResiduos();
                carregarEstatisticas();
            }
        }, 30000);
    </script>
</body>
</html>