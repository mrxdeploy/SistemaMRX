<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Estoque Ativo - MRX Systems</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        @media (max-width: 768px) {
            .container { padding-left: var(--spacing-md); padding-right: var(--spacing-md); }
            h1 { font-size: clamp(1.25rem, 5vw, 1.75rem) !important; }
            .card { padding: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 0.75rem !important; }
            .stat-number { font-size: 1.5rem !important; }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr !important; }
        }
        main.container { min-height: calc(100vh - 140px); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; }
        .stat-label { color: var(--gray-600); font-size: 0.875rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .tab-btn { padding: 0.75rem 1.5rem; border: none; background: var(--gray-200); border-radius: 0.5rem; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .tab-btn.active { background: var(--primary-color); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .lote-card { border-left: 4px solid var(--primary-color); margin-bottom: 1rem; cursor: pointer; transition: all 0.2s; }
        .lote-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .lote-card.em_estoque { border-left-color: var(--success-color); }
        .lote-card.em_producao { border-left-color: var(--warning-color); }
        .lote-card.disponivel { border-left-color: var(--info-color); }
        .lote-card.aprovado { border-left-color: var(--success-color); }
        .bag-card { border-left: 4px solid var(--success-color); margin-bottom: 1rem; cursor: pointer; transition: all 0.2s; }
        .bag-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .bag-card.cheio { border-left-color: var(--warning-color); }
        .bag-card.enviado_refinaria { border-left-color: var(--info-color); }
        .bag-card.devolvido_estoque { border-left-color: var(--success-color); }
        .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-purple { background: #ede9fe; color: #5b21b6; }
        
        .sublotes-container { 
            margin-top: 0.75rem; 
            padding: 0.75rem; 
            background: var(--gray-100); 
            border-radius: 0.5rem;
            display: none;
        }
        .sublotes-container.expanded { display: block; }
        .sublote-item {
            padding: 0.5rem;
            background: white;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--gray-200);
        }
        .sublote-item:last-child { margin-bottom: 0; }
        .expand-indicator { 
            display: inline-flex; 
            align-items: center; 
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--primary-color);
            cursor: pointer;
        }
        .expand-indicator i { transition: transform 0.2s; }
        .expand-indicator.expanded i { transform: rotate(180deg); }
        
        .itens-bag-container {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--gray-100);
            border-radius: 0.5rem;
            display: none;
        }
        .itens-bag-container.expanded { display: block; }
        .item-bag {
            padding: 0.5rem;
            background: white;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--gray-200);
        }
        .item-bag:last-child { margin-bottom: 0; }
        
        .search-box {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .search-box input {
            flex: 1;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content" style="justify-content: space-between;">
            <div class="logo">
                <img src="/static/images/mrx-logo.png" alt="MRX">
                <span>Estoque Ativo</span>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="notification-badge" onclick="window.location.href='/notificacoes.html'">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Sair</button>
            </div>
        </div>
    </header>

    <nav class="bottom-nav" id="navMenuMobile"></nav>

    <main class="container mt-4" style="padding-top: calc(70px + 1rem); padding-bottom: calc(80px + 1rem);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
            <h1 style="font-size: clamp(1.5rem, 6vw, 2rem); margin: 0;">
                <i class="fas fa-warehouse" style="color: var(--primary-color);"></i> Estoque Ativo
            </h1>
            <button class="btn btn-secondary" onclick="window.location.href='/administracao.html'">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
        </div>

        <div class="stats-grid" id="dashboardStats">
            <div class="card stat-card">
                <div class="stat-number" style="color: var(--success-color);" id="statLotesAtivos">0</div>
                <div class="stat-label">Lotes Ativos</div>
            </div>
            <div class="card stat-card">
                <div class="stat-number" style="color: var(--warning-color);" id="statEmProducao">0</div>
                <div class="stat-label">Em Produção</div>
            </div>
            <div class="card stat-card">
                <div class="stat-number" style="color: var(--info-color);" id="statBagsEstoque">0</div>
                <div class="stat-label">Bags no Estoque</div>
            </div>
            <div class="card stat-card">
                <div class="stat-number" style="color: #FFD700;" id="statPesoTotal">0 kg</div>
                <div class="stat-label">Peso Total</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="abrirTab('lotes')">
                <i class="fas fa-boxes"></i> Lotes
            </button>
            <button class="tab-btn" onclick="abrirTab('bags')">
                <i class="fas fa-box"></i> Bags
            </button>
            <button class="tab-btn" onclick="abrirTab('total')">
                <i class="fas fa-calculator"></i> Total Bags
            </button>
        </div>

        <div id="tabLotes" class="tab-content active">
            <div class="card" style="margin-bottom: 1rem;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                        <label>Status</label>
                        <select id="filtroStatusLote" onchange="carregarLotesAtivos()">
                            <option value="">Todos Ativos</option>
                            <option value="em_estoque">Em Estoque</option>
                            <option value="disponivel">Disponível</option>
                            <option value="aprovado">Aprovado</option>
                            <option value="em_producao">Em Produção</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 2; min-width: 200px; margin-bottom: 0;">
                        <label>Buscar</label>
                        <input type="text" id="buscaLote" placeholder="Número do lote, fornecedor..." onkeyup="filtrarLotes()">
                    </div>
                </div>
            </div>
            <div id="listaLotes"></div>
        </div>

        <div id="tabBags" class="tab-content">
            <div class="card" style="margin-bottom: 1rem;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                        <label>Status</label>
                        <select id="filtroStatusBag" onchange="carregarBagsEstoque()">
                            <option value="">Todos</option>
                            <option value="devolvido_estoque">Devolvidos ao Estoque</option>
                            <option value="cheio">Cheios</option>
                            <option value="enviado_refinaria">Enviados</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                        <label>Categoria</label>
                        <select id="filtroCategoriaBag" onchange="carregarBagsEstoque()">
                            <option value="">Todas</option>
                            <option value="HIGH_GRADE">High Grade</option>
                            <option value="MG1">MG1</option>
                            <option value="MG2">MG2</option>
                            <option value="LOW_GRADE">Low Grade</option>
                            <option value="RESIDUO">Resíduo</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 2; min-width: 200px; margin-bottom: 0;">
                        <label>Buscar</label>
                        <input type="text" id="buscaBag" placeholder="Código do bag..." onkeyup="filtrarBags()">
                    </div>
                </div>
            </div>
            <div id="listaBags"></div>
        </div>

        <div id="tabTotal" class="tab-content">
            <div class="stats-grid" id="resumoGrid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"></div>
             
            <div class="card">
                <h3 style="margin-top: 0; color: var(--primary-color); border-bottom: 2px solid var(--gray-200); padding-bottom: 0.5rem; margin-bottom: 1rem;">
                    <i class="fas fa-list"></i> Detalhamento por Classificação
                </h3>
                <div class="table-container">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-100); text-align: left;">
                                <th style="padding: 0.75rem; border-bottom: 2px solid var(--gray-300);">Classificação</th>
                                <th style="padding: 0.75rem; border-bottom: 2px solid var(--gray-300);">Categoria</th>
                                <th style="padding: 0.75rem; border-bottom: 2px solid var(--gray-300); text-align: right;">Peso Total</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaResumoBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/rbac.js"></script>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/chat-widget.js"></script>
    <script>
        let lotesAtivos = [];
        let bagsEstoque = [];

        async function carregarPagina() {
            const user = await verificarAuth();
            if (!user) return;
            await Promise.all([
                carregarDashboardEstoque(),
                carregarLotesAtivos(),
                carregarBagsEstoque(),
                carregarTotalBags()
            ]);
            await atualizarNotificacoes();
        }

        async function carregarDashboardEstoque() {
            try {
                const response = await fetchAPI('/estoque-ativo/dashboard');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('statLotesAtivos').textContent = data.lotes_ativos || 0;
                    document.getElementById('statEmProducao').textContent = data.em_producao || 0;
                    document.getElementById('statBagsEstoque').textContent = data.bags_estoque || 0;
                    document.getElementById('statPesoTotal').textContent = `${(data.peso_total || 0).toFixed(2)} kg`;
                }
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        async function carregarLotesAtivos() {
            try {
                const status = document.getElementById('filtroStatusLote').value;
                const url = status ? `/estoque-ativo/lotes?status=${status}` : '/estoque-ativo/lotes';
                const response = await fetchAPI(url);
                if (response.ok) {
                    lotesAtivos = await response.json();
                    renderizarLotes(lotesAtivos);
                }
            } catch (error) {
                console.error('Erro ao carregar lotes:', error);
                document.getElementById('listaLotes').innerHTML = '<div class="card" style="text-align: center; color: var(--danger-color);">Erro ao carregar lotes</div>';
            }
        }

        function filtrarLotes() {
            const busca = document.getElementById('buscaLote').value.toLowerCase();
            const lotesFiltrados = lotesAtivos.filter(lote => {
                const numero = (lote.numero_lote || '').toLowerCase();
                const fornecedor = (lote.fornecedor_nome || '').toLowerCase();
                const tipo = (lote.tipo_lote_nome || '').toLowerCase();
                return numero.includes(busca) || fornecedor.includes(busca) || tipo.includes(busca);
            });
            renderizarLotes(lotesFiltrados);
        }

        function renderizarLotes(lotes) {
            const container = document.getElementById('listaLotes');
            if (!lotes || lotes.length === 0) {
                container.innerHTML = '<div class="card" style="text-align: center; color: var(--gray-500);"><i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><br>Nenhum lote ativo encontrado</div>';
                return;
            }

            container.innerHTML = lotes.map(lote => {
                const temSublotes = lote.sublotes && lote.sublotes.length > 0;
                const pesoOriginal = parseFloat(lote.peso_liquido || lote.peso_total_kg || 0);
                const pesoSublotes = lote.peso_total_sublotes || 0;
                const foiSeparado = temSublotes && pesoSublotes > 0;
                
                return `
                <div class="card lote-card ${lote.status}" id="lote-${lote.id}">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 0.5rem;">
                        <div>
                            <h4 style="margin: 0 0 0.25rem 0; color: var(--primary-color);">
                                <i class="fas fa-box"></i> ${lote.numero_lote}
                            </h4>
                            <p style="margin: 0; font-size: 0.875rem; color: var(--gray-600);">
                                ${lote.observacoes && (lote.observacoes.startsWith('MATERIAL:') || lote.observacoes.startsWith('MATERIAL_MANUAL:')) ? lote.observacoes.split('|')[0].replace('MATERIAL_MANUAL:', '').replace('MATERIAL:', '').trim() : (lote.tipo_lote_nome || 'Tipo não especificado')}
                            </p>
                        </div>
                        <span class="badge ${getBadgeClassLote(lote.status)}">${getStatusLabelLote(lote.status)}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 1rem; font-size: 0.875rem;">
                        <div><strong>Peso Original:</strong> ${pesoOriginal.toFixed(2)} kg</div>
                        ${foiSeparado ? `<div><strong>Peso Separado:</strong> <span style="color: var(--success-color);">${pesoSublotes.toFixed(2)} kg</span></div>` : ''}
                        <div><strong>Fornecedor:</strong> ${lote.fornecedor_nome || 'N/A'}</div>
                        ${lote.localizacao_atual ? `<div><strong>Local:</strong> ${lote.localizacao_atual}</div>` : ''}
                    </div>
                    ${temSublotes ? `
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 2px solid var(--gray-200);">
                            <span class="expand-indicator" id="expand-${lote.id}" onclick="toggleSublotes(${lote.id}, event)">
                                <i class="fas fa-chevron-down"></i>
                                <span><strong>${lote.sublotes.length} material(is) separado(s)</strong> - Clique para expandir</span>
                            </span>
                        </div>
                        <div class="sublotes-container" id="sublotes-${lote.id}">
                            <div style="background: var(--success-bg); padding: 0.5rem; border-radius: 0.375rem; margin-bottom: 0.5rem;">
                                <strong style="color: var(--success-color);"><i class="fas fa-info-circle"></i> Materiais separados deste lote:</strong>
                            </div>
                            ${lote.sublotes.map((sublote, idx) => `
                                <div class="sublote-item">
                                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 0.5rem;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                                <span style="background: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">${idx + 1}</span>
                                                <strong style="color: var(--primary-color);">${sublote.numero_lote}</strong>
                                            </div>
                                            <div style="font-size: 0.8rem; color: var(--gray-700); margin-left: 2rem;">
                                                <i class="fas fa-tag"></i> <strong>Material:</strong> ${sublote.observacoes && (sublote.observacoes.startsWith('MATERIAL:') || sublote.observacoes.startsWith('MATERIAL_MANUAL:')) ? sublote.observacoes.split('|')[0].replace('MATERIAL_MANUAL:', '').replace('MATERIAL:', '').trim() : (sublote.tipo_lote_nome || 'N/A')}
                                            </div>
                                            <div style="font-size: 0.8rem; color: var(--gray-700); margin-left: 2rem;">
                                                <i class="fas fa-weight"></i> <strong>Peso:</strong> <span style="color: var(--success-color); font-weight: bold;">${parseFloat(sublote.peso_liquido || sublote.peso_total_kg || 0).toFixed(2)} kg</span>
                                            </div>
                                            ${sublote.qualidade_recebida ? `
                                                <div style="font-size: 0.8rem; color: var(--gray-700); margin-left: 2rem;">
                                                    <i class="fas fa-star"></i> <strong>Qualidade:</strong> ${sublote.qualidade_recebida}
                                                </div>
                                            ` : ''}
                                            ${sublote.localizacao_atual ? `
                                                <div style="font-size: 0.8rem; color: var(--gray-700); margin-left: 2rem;">
                                                    <i class="fas fa-map-marker-alt"></i> <strong>Localização:</strong> ${sublote.localizacao_atual}
                                                </div>
                                            ` : ''}
                                        </div>
                                        <span class="badge ${getBadgeClassLote(sublote.status)}" style="font-size: 0.65rem;">${getStatusLabelLote(sublote.status)}</span>
                                    </div>
                                </div>
                            `).join('')}
                            <div style="background: var(--gray-100); padding: 0.5rem; border-radius: 0.375rem; margin-top: 0.5rem; text-align: center; font-size: 0.8rem; color: var(--gray-700);">
                                <i class="fas fa-calculator"></i> <strong>Total separado:</strong> ${pesoSublotes.toFixed(2)} kg de ${lote.sublotes.length} tipo(s) de material
                            </div>
                        </div>
                    ` : `
                        <div style="margin-top: 0.75rem; padding: 0.5rem; background: var(--warning-bg); border-left: 3px solid var(--warning-color); border-radius: 0.25rem; font-size: 0.8rem;">
                            <i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i> 
                            <span style="color: var(--gray-700);">Este lote ainda não foi separado</span>
                        </div>
                    `}
                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem;">
                        <i class="fas fa-calendar"></i> Criado em ${formatarData(lote.data_criacao)}
                    </div>
                </div>
            `;
            }).join('');
        }

        function toggleSublotes(loteId, event) {
            event.stopPropagation();
            const container = document.getElementById(`sublotes-${loteId}`);
            const indicator = document.getElementById(`expand-${loteId}`);
            container.classList.toggle('expanded');
            indicator.classList.toggle('expanded');
        }

        async function carregarBagsEstoque() {
            try {
                const status = document.getElementById('filtroStatusBag').value;
                const categoria = document.getElementById('filtroCategoriaBag').value;
                let url = '/estoque-ativo/bags?';
                if (status) url += `status=${status}&`;
                if (categoria) url += `categoria=${categoria}`;
                const response = await fetchAPI(url);
                if (response.ok) {
                    bagsEstoque = await response.json();
                    renderizarBags(bagsEstoque);
                }
            } catch (error) {
                console.error('Erro ao carregar bags:', error);
                document.getElementById('listaBags').innerHTML = '<div class="card" style="text-align: center; color: var(--danger-color);">Erro ao carregar bags</div>';
            }
        }

        function filtrarBags() {
            const busca = document.getElementById('buscaBag').value.toLowerCase();
            const bagsFiltrados = bagsEstoque.filter(bag => {
                const codigo = (bag.codigo || '').toLowerCase();
                const classificacao = (bag.classificacao_nome || '').toLowerCase();
                return codigo.includes(busca) || classificacao.includes(busca);
            });
            renderizarBags(bagsFiltrados);
        }

        async function carregarTotalBags() {
            try {
                const response = await fetchAPI('/estoque-ativo/resumo');
                if(response.ok) {
                     const dados = await response.json();
                     renderizarResumo(dados);
                }
            } catch(e) { console.error('Erro ao carregar resumo:', e); }
        }

        function renderizarResumo(dados) {
            // Renderizar Cards
            const grid = document.getElementById('resumoGrid');
            if(!dados || dados.length === 0) {
                grid.innerHTML = '<div class="card" style="grid-column: 1/-1; text-align: center;">Nenhum dado encontrado</div>';
                document.getElementById('tabelaResumoBody').innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 1rem;">Nenhum registro</td></tr>';
                return;
            }

            grid.innerHTML = dados.map(cat => `
                <div class="card stat-card" style="border-left: 4px solid var(--primary-color);">
                    <div class="stat-number" style="font-size: 1.5rem; color: var(--primary-color);">
                        ${cat.peso_total.toFixed(2)} kg
                    </div>
                    <div class="stat-label" style="font-weight: bold; color: var(--gray-700);">${cat.categoria_label}</div>
                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">
                        ${cat.classificacoes.length} classificações
                    </div>
                </div>
            `).join('');

            // Renderizar Tabela
            const tbody = document.getElementById('tabelaResumoBody');
            let rows = '';
            dados.forEach(cat => {
                // Cabeçalho de categoria
                rows += `<tr style="background-color: var(--gray-100); font-weight: bold;"><td colspan="3" style="padding: 0.5rem 0.75rem; color: var(--gray-800);">${cat.categoria_label}</td></tr>`;
                
                cat.classificacoes.forEach(cls => {
                    rows += `
                        <tr style="border-bottom: 1px solid var(--gray-200);">
                            <td style="padding: 0.75rem 0.75rem 0.75rem 2rem;">${cls.nome}</td>
                            <td style="padding: 0.75rem;">${cat.categoria_label}</td>
                            <td style="padding: 0.75rem; text-align: right; color: var(--success-color); font-weight: bold;">${cls.peso.toFixed(2)} kg</td>
                        </tr>
                    `;
                });
            });
            tbody.innerHTML = rows;
        }

        function renderizarBags(bags) {
            const container = document.getElementById('listaBags');
            if (!bags || bags.length === 0) {
                container.innerHTML = '<div class="card" style="text-align: center; color: var(--gray-500);"><i class="fas fa-box-open" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><br>Nenhum bag encontrado no estoque</div>';
                return;
            }
            
            // Cores para categorias
            // Cores para categorias
            const categoriaCores = {
                'HIGH_GRADE': '#10B981',  // Verde
                'high': '#10B981',
                'High Category': '#10B981',
                'MID_GRADE': '#EAB308',   // Amarelo
                'MID_GRADE_1': '#EAB308',
                'mg1': '#EAB308',
                'MG1': '#EAB308',
                'MID_GRADE_2': '#F97316',  // Laranja
                'mg2': '#F97316',
                'MG2': '#F97316',
                'LOW_GRADE': '#EF4444',   // Vermelho
                'low': '#EF4444',
                'RESIDUO': '#6B7280',     // Cinza
                'OUTRO': '#6B7280'
            };
            
            const categoriaNomes = {
                'HIGH_GRADE': 'High',
                'high': 'High',
                'MID_GRADE': 'MG1',
                'MID_GRADE_1': 'MG1',
                'mg1': 'MG1',
                'MG1': 'MG1',
                'MID_GRADE_2': 'MG2',
                'mg2': 'MG2',
                'MG2': 'MG2',
                'LOW_GRADE': 'Low',
                'low': 'Low',
                'RESIDUO': 'Resíduo'
            };

            container.innerHTML = bags.map(bag => {
                const temItens = bag.itens && bag.itens.length > 0;
                const origemTexto = bag.origem_lotes ? 'Origem: Lotes separados' : 'Origem: Criado manualmente';
                const corCategoria = categoriaCores[bag.categoria_exibicao] || 'var(--primary-color)';
                const nomeCategoria = categoriaNomes[bag.categoria_exibicao] || getCategoriaLabel(bag.categoria_exibicao) || bag.classificacao_nome || 'Sem classificação';
                
                // Renderizar breakdown de itens
                let itensBreakdownHtml = '';
                if (bag.itens_por_classificacao && bag.itens_por_classificacao.length > 0) {
                    itensBreakdownHtml = `
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--gray-200);">
                            <p style="font-size: 0.7rem; color: var(--gray-500); margin-bottom: 0.5rem; text-transform: uppercase;">Detalhamento:</p>
                            ${bag.itens_por_classificacao.map(item => `
                                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.8rem;">
                                    <span>${item.nome}</span>
                                    <span style="font-weight: bold;">${item.peso_total_kg.toFixed(2)} kg</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                return `
                <div class="card bag-card ${bag.status}" id="bag-${bag.id}" style="border-left-color: ${corCategoria};">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 0.5rem;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ${corCategoria};"></span>
                                <h4 style="margin: 0; color: var(--primary-color);">${nomeCategoria}</h4>
                            </div>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: var(--gray-500);">
                                ${bag.codigo}
                                ${bag.categorias_mistas ? '<span class="badge badge-warning" style="margin-left: 0.5rem; font-size: 0.6rem;">Misto</span>' : ''}
                            </p>
                        </div>
                        <span class="badge ${getBagBadgeClass(bag.status)}">${getBagStatusLabel(bag.status)}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 1rem; font-size: 0.875rem;">
                        <div><strong>Peso Total:</strong> ${parseFloat(bag.peso_acumulado || 0).toFixed(2)} kg</div>
                        <div><strong>Itens:</strong> ${bag.quantidade_itens || 0}</div>
                    </div>
                    ${itensBreakdownHtml}
                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem;">
                        <i class="fas fa-info-circle"></i> ${origemTexto}
                    </div>
                    ${temItens ? `
                        <div style="margin-top: 0.75rem;">
                            <span class="expand-indicator" id="expand-bag-${bag.id}" onclick="toggleItensBag(${bag.id}, event)">
                                <i class="fas fa-chevron-down"></i>
                                <span>${bag.itens.length} item(ns) no bag</span>
                            </span>
                        </div>
                        <div class="itens-bag-container" id="itens-bag-${bag.id}">
                            ${bag.itens.map(item => `
                                <div class="item-bag">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong style="color: var(--primary-color);">${item.nome_item || item.classificacao_nome || 'Item'}</strong>
                                        </div>
                                        <span style="font-size: 0.75rem; color: var(--gray-600);">${parseFloat(item.peso_kg || 0).toFixed(2)} kg</span>
                                    </div>
                                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--gray-500);">
                                        ${item.classificacao_nome ? `Classificação: ${item.classificacao_nome}` : ''}
                                        ${item.ordem_producao_numero ? ` | OP: ${item.ordem_producao_numero}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem;">
                        Criado em ${formatarData(bag.data_criacao)}
                    </div>
                </div>
            `;
            }).join('');
        }

        function toggleItensBag(bagId, event) {
            event.stopPropagation();
            const container = document.getElementById(`itens-bag-${bagId}`);
            const indicator = document.getElementById(`expand-bag-${bagId}`);
            container.classList.toggle('expanded');
            indicator.classList.toggle('expanded');
        }

        function abrirTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
            
            if (tabName === 'bags') {
                carregarBagsEstoque();
            } else {
                carregarLotesAtivos();
            }
        }

        function getBadgeClassLote(status) {
            const s = (status || '').toLowerCase();
            switch(s) {
                case 'em_estoque': return 'badge-success';
                case 'disponivel': return 'badge-info';
                case 'aprovado': return 'badge-success';
                case 'em_producao': return 'badge-warning';
                case 'processado': return 'badge-purple';
                case 'criado_separacao': return 'badge-success';
                default: return 'badge-info';
            }
        }

        function getStatusLabelLote(status) {
            const s = (status || '').toLowerCase();
            switch(s) {
                case 'em_estoque': return 'Em Estoque';
                case 'disponivel': return 'Disponível';
                case 'aprovado': return 'Aprovado';
                case 'em_producao': return 'Em Produção';
                case 'processado': return 'Processado';
                case 'criado_separacao': return 'Em Estoque';
                default: return status || 'N/A';
            }
        }

        function getBagBadgeClass(status) {
            switch(status) {
                case 'aberto': return 'badge-info';
                case 'cheio': return 'badge-warning';
                case 'enviado_refinaria': return 'badge-purple';
                case 'devolvido_estoque': return 'badge-success';
                default: return 'badge-info';
            }
        }

        function getBagStatusLabel(status) {
            switch(status) {
                case 'aberto': return 'Aberto';
                case 'cheio': return 'Cheio';
                case 'enviado_refinaria': return 'Enviado';
                case 'devolvido_estoque': return 'No Estoque';
                default: return status || 'N/A';
            }
        }

        function getCategoriaLabel(categoria) {
            switch(categoria) {
                case 'HIGH_GRADE': return 'High Grade';
                case 'high': return 'High Grade';
                case 'MID_GRADE': return 'Mid Grade';
                case 'MID_GRADE_1': return 'MG1';
                case 'mg1': return 'MG1';
                case 'MG1': return 'MG1';
                case 'MID_GRADE_2': return 'MG2';
                case 'mg2': return 'MG2';
                case 'MG2': return 'MG2';
                case 'LOW_GRADE': return 'Low Grade';
                case 'low': return 'Low Grade';
                case 'RESIDUO': return 'Resíduo';
                default: return categoria || 'N/A';
            }
        }

        function formatarData(dataStr) {
            if (!dataStr) return 'N/A';
            const data = new Date(dataStr);
            return data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        carregarPagina();
    </script>
</body>
</html>
