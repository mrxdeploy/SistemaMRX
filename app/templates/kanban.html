<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban - Logística MRX</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .kanban-container {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .kanban-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .kanban-header h1 {
            color: #2c7a3e;
            margin: 0;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .kanban-column {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            min-height: 600px;
        }

        .kanban-column-header {
            font-weight: 700;
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #2c7a3e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-column-header .count {
            background: #2c7a3e;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        .kanban-card {
            background: white;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: move;
            transition: all 0.3s;
        }

        .kanban-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .kanban-card-header {
            font-weight: 600;
            color: #2c7a3e;
            margin-bottom: 8px;
        }

        .kanban-card-info {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .kanban-card-info strong {
            color: #333;
        }

        .kanban-card-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #2c7a3e;
            color: white;
        }

        .btn-small:hover {
            background: #235d31;
        }

        .dragging {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content" style="justify-content: space-between;">
            <div class="logo">
                <img src="/static/images/mrx-logo.png" alt="MRX">
                <span>Kanban</span>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="notification-badge" onclick="window.location.href='/notificacoes.html'">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Sair</button>
            </div>
        </div>
    </header>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav" id="navMenuMobile">
        <!-- Menus serão renderizados dinamicamente pelo RBAC -->
    </nav>

    <div class="kanban-container">
        <div class="kanban-header">
            <h1>Kanban - Ordens de Serviço</h1>
            <a href="/logistica" style="background: #2c7a3e; color: white; padding: 10px 20px; border-radius: 4px; text-decoration: none;">Voltar para Listagem</a>
        </div>

        <div class="kanban-board">
            <div class="kanban-column" data-status="PENDENTE">
                <div class="kanban-column-header">
                    <span>Pendente</span>
                    <span class="count" id="count-PENDENTE">0</span>
                </div>
                <div class="kanban-cards" id="cards-PENDENTE"></div>
            </div>

            <div class="kanban-column" data-status="AGENDADA">
                <div class="kanban-column-header">
                    <span>Agendada</span>
                    <span class="count" id="count-AGENDADA">0</span>
                </div>
                <div class="kanban-cards" id="cards-AGENDADA"></div>
            </div>

            <div class="kanban-column" data-status="EM_ROTA">
                <div class="kanban-column-header">
                    <span>Em Rota</span>
                    <span class="count" id="count-EM_ROTA">0</span>
                </div>
                <div class="kanban-cards" id="cards-EM_ROTA"></div>
            </div>

            <div class="kanban-column" data-status="ENTREGUE">
                <div class="kanban-column-header">
                    <span>Entregue</span>
                    <span class="count" id="count-ENTREGUE">0</span>
                </div>
                <div class="kanban-cards" id="cards-ENTREGUE"></div>
            </div>

            <div class="kanban-column" data-status="FINALIZADA">
                <div class="kanban-column-header">
                    <span>Finalizada</span>
                    <span class="count" id="count-FINALIZADA">0</span>
                </div>
                <div class="kanban-cards" id="cards-FINALIZADA"></div>
            </div>

            <div class="kanban-column" data-status="CANCELADA">
                <div class="kanban-column-header">
                    <span>Cancelada</span>
                    <span class="count" id="count-CANCELADA">0</span>
                </div>
                <div class="kanban-cards" id="cards-CANCELADA"></div>
            </div>
        </div>
    </div>

    <script>
        let draggedElement = null;

        async function carregarKanban() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/os', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const os_list = await response.json();

                const contadores = {
                    'PENDENTE': 0,
                    'AGENDADA': 0,
                    'EM_ROTA': 0,
                    'ENTREGUE': 0,
                    'FINALIZADA': 0,
                    'CANCELADA': 0
                };

                document.querySelectorAll('.kanban-cards').forEach(col => col.innerHTML = '');

                os_list.forEach(os => {
                    const card = criarCard(os);
                    const container = document.getElementById(`cards-${os.status}`);
                    if (container) {
                        container.appendChild(card);
                        contadores[os.status]++;
                    }
                });

                Object.keys(contadores).forEach(status => {
                    const countEl = document.getElementById(`count-${status}`);
                    if (countEl) countEl.textContent = contadores[status];
                });
            } catch (error) {
                console.error('Erro ao carregar kanban:', error);
            }
        }

        function criarCard(os) {
            const card = document.createElement('div');
            card.className = 'kanban-card';
            card.draggable = true;
            card.dataset.osId = os.id;

            card.innerHTML = `
                <div class="kanban-card-header">${os.numero_os}</div>
                <div class="kanban-card-info"><strong>Fornecedor:</strong> ${os.fornecedor_snapshot.nome}</div>
                <div class="kanban-card-info"><strong>Tipo:</strong> ${os.tipo}</div>
                <div class="kanban-card-info"><strong>Motorista:</strong> ${os.motorista_nome || 'Não atribuído'}</div>
                ${os.janela_coleta_inicio ? `<div class="kanban-card-info"><strong>Janela:</strong> ${new Date(os.janela_coleta_inicio).toLocaleDateString('pt-BR')}</div>` : ''}
                <div class="kanban-card-actions">
                    <button class="btn-small" onclick="verDetalhesOS(${os.id})">Ver Detalhes</button>
                </div>
            `;

            card.addEventListener('dragstart', (e) => {
                draggedElement = card;
                card.classList.add('dragging');
            });

            card.addEventListener('dragend', (e) => {
                card.classList.remove('dragging');
                draggedElement = null;
            });

            return card;
        }

        document.querySelectorAll('.kanban-cards').forEach(container => {
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            container.addEventListener('drop', async (e) => {
                e.preventDefault();
                if (draggedElement) {
                    const novoStatus = container.closest('.kanban-column').dataset.status;
                    const osId = draggedElement.dataset.osId;
                    
                    console.log('Movendo OS', osId, 'para status', novoStatus);
                }
            });
        });

        function verDetalhesOS(osId) {
            window.location.href = `/logistica?os=${osId}`;
        }

        carregarKanban();
        setInterval(carregarKanban, 30000);
    </script>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/chat-widget.js"></script>
    <script src="/static/js/scanner-widget.js"></script>
    <script src="/static/js/rbac.js"></script>
</body>
</html>
