<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ordem de Produção - MRX Systems</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        @media (max-width: 768px) {
            .container { padding-left: var(--spacing-md); padding-right: var(--spacing-md); }
            h1 { font-size: clamp(1.25rem, 5vw, 1.75rem) !important; }
            .card { padding: 1rem; }
            .info-grid { grid-template-columns: 1fr !important; }
        }
        main.container { min-height: calc(100vh - 140px); }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .info-item { background: var(--gray-100); padding: 0.75rem; border-radius: 0.5rem; }
        .info-label { font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; }
        .info-value { font-size: 1rem; font-weight: 600; color: var(--gray-800); }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 600; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .item-card { background: white; border: 1px solid var(--gray-200); border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .item-card:hover { border-color: var(--primary-color); }
        .progress-bar { height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden; margin-top: 0.5rem; }
        .progress-fill { height: 100%; background: var(--success-color); transition: width 0.3s; }
        .section-title { font-size: 1.125rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--gray-800); display: flex; align-items: center; gap: 0.5rem; }
        .action-buttons { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1.5rem; }
    </style>
</head>
<body>
    <header>
        <div class="header-content" style="justify-content: space-between;">
            <div class="logo">
                <a href="/api/producao/" style="display: flex; align-items: center; gap: 0.5rem; text-decoration: none; color: inherit;">
                    <i class="fas fa-arrow-left"></i>
                    <img src="/static/images/mrx-logo.png" alt="MRX">
                    <span id="headerNumeroOP">Ordem de Produção</span>
                </a>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="btn btn-secondary" onclick="logout()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Sair</button>
            </div>
        </div>
    </header>

    <nav class="bottom-nav" id="navMenuMobile"></nav>

    <main class="container mt-4" style="padding-top: calc(70px + 1rem); padding-bottom: calc(80px + 1rem);">
        <div id="opContent">
            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <h1 style="font-size: clamp(1.5rem, 6vw, 2rem); margin: 0;" id="opNumero">Carregando...</h1>
                    <p style="color: var(--gray-600); margin: 0.25rem 0 0 0;" id="opTipo"></p>
                </div>
                <span class="badge" id="opStatusBadge"></span>
            </div>

            <div class="card">
                <h3 style="margin: 0 0 1rem 0;">Informações da OP</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Peso de Entrada</div>
                        <div class="info-value" id="opPesoEntrada">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Peso Separado</div>
                        <div class="info-value" id="opPesoSeparado">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Custo Total</div>
                        <div class="info-value" id="opCusto">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Custo/kg</div>
                        <div class="info-value" id="opCustoKg">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Valor Estimado</div>
                        <div class="info-value" id="opValorEstimado">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Lucro/Prejuízo</div>
                        <div class="info-value" id="opLucro">-</div>
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <div class="info-label">Progresso da Separação</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;" id="progressText">0%</div>
                </div>
            </div>

            <!-- Banner de Análise de Categoria -->
            <div id="categoriaAnaliseContainer" style="display: none; margin-top: 1rem;"></div>

            <div class="section-title">
                <i class="fas fa-boxes" style="color: var(--primary-color);"></i>
                Itens Separados
                <button class="btn btn-primary btn-sm" onclick="abrirModalNovoItem()" id="btnNovoItem" style="margin-left: auto;">
                    <i class="fas fa-plus"></i> Adicionar Item
                </button>
            </div>
            <div id="listaItens"></div>

            <div class="action-buttons" id="actionButtons">
                <button class="btn btn-primary" onclick="iniciarSeparacao()" id="btnIniciar" style="display: none;">
                    <i class="fas fa-play"></i> Iniciar Separação
                </button>
                <button class="btn btn-success" onclick="finalizarOP()" id="btnFinalizar" style="display: none;">
                    <i class="fas fa-check"></i> Finalizar OP
                </button>
                <button class="btn btn-danger" onclick="cancelarOP()" id="btnCancelar" style="display: none;">
                    <i class="fas fa-times"></i> Cancelar OP
                </button>
            </div>
        </div>
    </main>

    <div class="modal" id="modalNovoItem">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Adicionar Item Separado</h3>
                <span class="modal-close" onclick="fecharModal('modalNovoItem')">&times;</span>
            </div>
            <form id="formNovoItem" onsubmit="salvarItem(event)">
                <div class="form-group">
                    <label>Classificação</label>
                    <select id="itemClassificacao" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nome do Item (opcional)</label>
                    <input type="text" id="itemNome" placeholder="Ex: Processador Intel i7">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Peso (kg)</label>
                        <input type="number" id="itemPeso" step="0.001" min="0.001" required>
                    </div>
                    <div class="form-group">
                        <label>Quantidade</label>
                        <input type="number" id="itemQuantidade" min="1" value="1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea id="itemObservacoes" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal('modalNovoItem')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Categoria Manual para Bags Mistos -->
    <div class="modal" id="modalCategoriaManual">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Definir Categoria do Bag</h3>
                <span class="modal-close" onclick="fecharModal('modalCategoriaManual')">&times;</span>
            </div>
            <div style="padding: 1rem; background: #fef3c7; border-radius: 0.5rem; margin-bottom: 1rem;">
                <i class="fas fa-exclamation-triangle" style="color: #92400e;"></i>
                <span style="color: #92400e;">Este bag contém itens de categorias diferentes. Por favor, defina um nome para identificar a categoria deste bag.</span>
            </div>
            <form id="formCategoriaManual" onsubmit="confirmarFinalizacaoComCategoria(event)">
                <div class="form-group">
                    <label>Nome da Categoria do Bag</label>
                    <input type="text" id="inputCategoriaManual" placeholder="Ex: High Grade Misto, Teste Processadores" required>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal('modalCategoriaManual')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Finalizar OP</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/rbac.js"></script>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/chat-widget.js"></script>
    <script>
        let ordemId = null;
        let ordem = null;
        let classificacoes = [];
        let analiseCategoria = { misto: false, categorias: [], categoriaUnica: null };

        async function carregarPagina() {
            const user = await verificarAuth();
            if (!user) return;
            
            const pathParts = window.location.pathname.split('/');
            ordemId = parseInt(pathParts[pathParts.length - 1]);
            
            if (!ordemId || isNaN(ordemId)) {
                showAlert('ID da ordem inválido', 'error');
                return;
            }
            
            await Promise.all([
                carregarOrdem(),
                carregarClassificacoes()
            ]);
        }

        async function carregarOrdem() {
            try {
                if (classificacoes.length === 0) {
                    await carregarClassificacoes();
                }
                const response = await fetchAPI(`/producao/ordens/${ordemId}`);
                if (response.ok) {
                    ordem = await response.json();
                    renderizarOrdem();
                } else {
                    showAlert('Erro ao carregar ordem', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao carregar ordem', 'error');
            }
        }

        async function carregarClassificacoes() {
            try {
                const response = await fetchAPI('/producao/classificacoes');
                if (response.ok) {
                    classificacoes = await response.json();
                    const select = document.getElementById('itemClassificacao');
                    select.innerHTML = '<option value="">Selecione...</option>';
                    const grupos = {};
                    classificacoes.forEach(c => {
                        if (!grupos[c.categoria]) grupos[c.categoria] = [];
                        grupos[c.categoria].push(c);
                    });
                    Object.keys(grupos).sort().forEach(cat => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = getCategoriaLabel(cat);
                        grupos[cat].forEach(c => {
                            const option = document.createElement('option');
                            option.value = c.id;
                            option.textContent = `${c.nome} ${c.preco_estimado_kg ? `(R$ ${parseFloat(c.preco_estimado_kg).toFixed(2)}/kg)` : ''}`;
                            optgroup.appendChild(option);
                        });
                        select.appendChild(optgroup);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar classificações:', error);
            }
        }

        function renderizarOrdem() {
            document.getElementById('headerNumeroOP').textContent = ordem.numero_op;
            document.getElementById('opNumero').textContent = ordem.numero_op;
            const tipoContainer = document.getElementById('opTipo');
            const tiposMaterial = (ordem.tipo_material || 'Material não especificado').split(', ').filter(t => t.trim());
            if (tiposMaterial.length > 1) {
                tipoContainer.innerHTML = tiposMaterial.map(tipo => 
                    `<span class="badge badge-success" style="margin-right: 0.25rem;">${tipo.trim()}</span>`
                ).join('');
            } else {
                tipoContainer.textContent = tiposMaterial[0] || 'Material não especificado';
            }
            
            const badgeEl = document.getElementById('opStatusBadge');
            badgeEl.textContent = getStatusLabel(ordem.status);
            badgeEl.className = `badge ${getBadgeClass(ordem.status)}`;
            
            const pesoEntrada = parseFloat(ordem.peso_entrada) || 0;
            const pesoSeparado = parseFloat(ordem.peso_total_separado) || 0;
            const custoTotal = parseFloat(ordem.custo_total) || 0;
            const custoKg = parseFloat(ordem.custo_unitario) || 0;
            const valorEstimado = parseFloat(ordem.valor_estimado_total) || 0;
            const lucro = parseFloat(ordem.lucro_prejuizo) || 0;
            
            document.getElementById('opPesoEntrada').textContent = `${pesoEntrada.toFixed(3)} kg`;
            document.getElementById('opPesoSeparado').textContent = `${pesoSeparado.toFixed(3)} kg`;
            document.getElementById('opCusto').textContent = `R$ ${custoTotal.toFixed(2)}`;
            document.getElementById('opCustoKg').textContent = `R$ ${custoKg.toFixed(2)}`;
            document.getElementById('opValorEstimado').textContent = `R$ ${valorEstimado.toFixed(2)}`;
            
            const lucroEl = document.getElementById('opLucro');
            lucroEl.textContent = `R$ ${lucro.toFixed(2)}`;
            lucroEl.style.color = lucro >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
            
            const progresso = pesoEntrada > 0 ? Math.min(100, (pesoSeparado / pesoEntrada) * 100) : 0;
            document.getElementById('progressBar').style.width = `${progresso}%`;
            document.getElementById('progressText').textContent = `${progresso.toFixed(1)}% separado`;
            
            renderizarItens(ordem.itens_separados || []);
            atualizarBotoes();
            analisarCategorias();
        }

        function analisarCategorias() {
            const container = document.getElementById('categoriaAnaliseContainer');
            const itens = ordem.itens_separados || [];
            
            if (itens.length === 0) {
                container.style.display = 'none';
                analiseCategoria = { misto: false, categorias: [], categoriaUnica: null };
                return;
            }
            
            const categoriasSet = new Set();
            itens.forEach(item => {
                const classif = classificacoes.find(c => c.id === item.classificacao_grade_id);
                if (classif) categoriasSet.add(classif.categoria);
            });
            
            const categoriasArray = Array.from(categoriasSet);
            analiseCategoria.categorias = categoriasArray;
            
            if (categoriasArray.length === 1) {
                analiseCategoria.misto = false;
                analiseCategoria.categoriaUnica = categoriasArray[0];
                container.innerHTML = `
                    <div class="card" style="background: #d1fae5; border: 1px solid #059669;">
                        <i class="fas fa-check-circle" style="color: #059669;"></i>
                        <span style="color: #065f46; margin-left: 0.5rem;">Todos os itens pertencem à categoria: <strong>${getCategoriaLabel(categoriasArray[0])}</strong></span>
                    </div>`;
                container.style.display = 'block';
            } else if (categoriasArray.length > 1) {
                analiseCategoria.misto = true;
                analiseCategoria.categoriaUnica = null;
                const labels = categoriasArray.map(c => getCategoriaLabel(c)).join(', ');
                container.innerHTML = `
                    <div class="card" style="background: #fef3c7; border: 1px solid #f59e0b;">
                        <i class="fas fa-exclamation-triangle" style="color: #92400e;"></i>
                        <span style="color: #92400e; margin-left: 0.5rem;">Categorias mistas detectadas: <strong>${labels}</strong>. Ao finalizar, será necessário definir um nome para a categoria do bag.</span>
                    </div>`;
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        function renderizarItens(itens) {
            const container = document.getElementById('listaItens');
            if (!itens || itens.length === 0) {
                container.innerHTML = '<div class="card" style="text-align: center; color: var(--gray-500);">Nenhum item separado ainda</div>';
                return;
            }
            container.innerHTML = itens.map(item => `
                <div class="item-card">
                    <div style="flex: 1;">
                        <strong>${item.nome_item || getClassificacaoNome(item.classificacao_grade_id)}</strong>
                        <div style="font-size: 0.875rem; color: var(--gray-600);">
                            ${item.peso_kg ? `${parseFloat(item.peso_kg).toFixed(3)} kg` : ''} 
                            ${item.quantidade ? `- ${item.quantidade} un.` : ''}
                            ${item.valor_estimado ? ` - Est: R$ ${parseFloat(item.valor_estimado).toFixed(2)}` : ''}
                        </div>
                    </div>
                    ${ordem.status !== 'finalizada' ? `
                        <button class="btn btn-danger btn-sm" onclick="removerItem(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        function getClassificacaoNome(id) {
            const c = classificacoes.find(x => x.id === id);
            return c ? c.nome : 'Sem classificação';
        }

        function atualizarBotoes() {
            const btnNovoItem = document.getElementById('btnNovoItem');
            const btnIniciar = document.getElementById('btnIniciar');
            const btnFinalizar = document.getElementById('btnFinalizar');
            const btnCancelar = document.getElementById('btnCancelar');
            
            btnNovoItem.style.display = ['aberta', 'em_separacao'].includes(ordem.status) ? 'inline-flex' : 'none';
            btnIniciar.style.display = ordem.status === 'aberta' ? 'inline-flex' : 'none';
            btnFinalizar.style.display = ['aberta', 'em_separacao'].includes(ordem.status) ? 'inline-flex' : 'none';
            btnCancelar.style.display = ordem.status !== 'finalizada' && ordem.status !== 'cancelada' ? 'inline-flex' : 'none';
        }

        function abrirModalNovoItem() {
            document.getElementById('formNovoItem').reset();
            document.getElementById('modalNovoItem').style.display = 'flex';
        }

        async function salvarItem(event) {
            event.preventDefault();
            try {
                const dados = {
                    classificacao_grade_id: parseInt(document.getElementById('itemClassificacao').value),
                    nome_item: document.getElementById('itemNome').value,
                    peso_kg: parseFloat(document.getElementById('itemPeso').value),
                    quantidade: parseInt(document.getElementById('itemQuantidade').value) || 1,
                    observacoes: document.getElementById('itemObservacoes').value
                };
                
                const response = await fetchAPI(`/producao/ordens/${ordemId}/itens`, {
                    method: 'POST',
                    body: JSON.stringify(dados)
                });
                
                if (response.ok) {
                    showAlert('Item adicionado com sucesso!', 'success');
                    fecharModal('modalNovoItem');
                    carregarOrdem();
                } else {
                    const erro = await response.json();
                    showAlert(erro.erro || 'Erro ao adicionar item', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao adicionar item', 'error');
            }
        }

        async function removerItem(itemId) {
            if (!confirm('Confirma a remoção deste item?')) return;
            try {
                const response = await fetchAPI(`/producao/itens/${itemId}`, { method: 'DELETE' });
                if (response.ok) {
                    showAlert('Item removido!', 'success');
                    carregarOrdem();
                } else {
                    const erro = await response.json();
                    showAlert(erro.erro || 'Erro ao remover', 'error');
                }
            } catch (error) {
                showAlert('Erro ao remover item', 'error');
            }
        }

        async function iniciarSeparacao() {
            try {
                const response = await fetchAPI(`/producao/ordens/${ordemId}/iniciar-separacao`, { method: 'POST' });
                if (response.ok) {
                    showAlert('Separação iniciada!', 'success');
                    carregarOrdem();
                } else {
                    const erro = await response.json();
                    showAlert(erro.erro || 'Erro ao iniciar', 'error');
                }
            } catch (error) {
                showAlert('Erro ao iniciar separação', 'error');
            }
        }

        async function finalizarOP() {
            if (!confirm('Confirma a finalização desta Ordem de Produção?')) return;
            
            if (analiseCategoria.misto) {
                document.getElementById('modalCategoriaManual').style.display = 'flex';
                return;
            }
            
            await executarFinalizacao();
        }

        async function executarFinalizacao(categoriaManual = null) {
            try {
                const body = categoriaManual ? JSON.stringify({ categoria_manual: categoriaManual }) : null;
                const response = await fetchAPI(`/producao/ordens/${ordemId}/finalizar`, {
                    method: 'POST',
                    body: body
                });
                if (response.ok) {
                    showAlert('OP finalizada com sucesso!', 'success');
                    fecharModal('modalCategoriaManual');
                    carregarOrdem();
                } else {
                    const erro = await response.json();
                    if (erro.categorias_mistas) {
                        analiseCategoria.misto = true;
                        analiseCategoria.categorias = erro.categorias || [];
                        document.getElementById('modalCategoriaManual').style.display = 'flex';
                        showAlert('Por favor, defina uma categoria para este bag misto.', 'warning');
                    } else {
                        showAlert(erro.erro || 'Erro ao finalizar', 'error');
                    }
                }
            } catch (error) {
                showAlert('Erro ao finalizar OP', 'error');
            }
        }

        async function confirmarFinalizacaoComCategoria(event) {
            event.preventDefault();
            const categoriaManual = document.getElementById('inputCategoriaManual').value.trim();
            if (!categoriaManual) {
                showAlert('Por favor, informe a categoria', 'error');
                return;
            }
            await executarFinalizacao(categoriaManual);
        }

        async function cancelarOP() {
            if (!confirm('Tem certeza que deseja cancelar esta OP? Esta ação não pode ser desfeita.')) return;
            try {
                const response = await fetchAPI(`/producao/ordens/${ordemId}/cancelar`, { method: 'POST' });
                if (response.ok) {
                    showAlert('OP cancelada', 'success');
                    carregarOrdem();
                } else {
                    const erro = await response.json();
                    showAlert(erro.erro || 'Erro ao cancelar', 'error');
                }
            } catch (error) {
                showAlert('Erro ao cancelar OP', 'error');
            }
        }

        function fecharModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function getBadgeClass(status) {
            const classes = { aberta: 'badge-warning', em_separacao: 'badge-info', finalizada: 'badge-success', cancelada: 'badge-danger' };
            return classes[status] || 'badge-info';
        }

        function getStatusLabel(status) {
            const labels = { aberta: 'Aberta', em_separacao: 'Em Separação', finalizada: 'Finalizada', cancelada: 'Cancelada' };
            return labels[status] || status;
        }

        function getCategoriaLabel(cat) {
            const labels = { HIGH_GRADE: 'High Grade', MID_GRADE: 'Mid Grade', LOW_GRADE: 'Low Grade', RESIDUO: 'Resíduo' };
            return labels[cat] || cat;
        }

        carregarPagina();
    </script>
</body>
</html>
