<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras e Despesas - MRX Systems</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <div class="header-content" style="justify-content: space-between;">
            <div class="logo">
                <img src="/static/images/mrx-logo.png" alt="MRX">
                <span>Compras</span>
            </div>
            <div class="notification-badge" onclick="window.location.href='/notificacoes.html'">
                <i class="fas fa-bell"></i>
                <span class="notification-count" style="display: none;">0</span>
            </div>
        </div>
    </header>

    <nav class="bottom-nav">
        <a href="/administracao.html" class="bottom-nav-item">
            <i class="fas fa-cog icon"></i>
            <span>Admin</span>
        </a>
        <a href="/dashboard.html" class="bottom-nav-item">
            <i class="fas fa-chart-line icon"></i>
            <span>Dashboard</span>
        </a>
        <div class="fab-container">
            <button class="fab-button" onclick="abrirModalNovaCompra()" aria-label="Nova Compra">
                <i class="fas fa-plus icon"></i>
            </button>
        </div>
        <a href="/compras.html" class="bottom-nav-item active">
            <i class="fas fa-shopping-cart icon"></i>
            <span>Compras</span>
        </a>
        <a href="/fornecedores.html" class="bottom-nav-item">
            <i class="fas fa-building icon"></i>
            <span>Fornecedores</span>
        </a>
    </nav>

    <main class="container mt-4">
        <div class="flex justify-between items-center mb-3" style="flex-wrap: wrap; gap: var(--spacing-md);">
            <h1 style="font-size: clamp(1.5rem, 6vw, 2rem);">Compras e Despesas</h1>
        </div>

        <div class="stats-grid" style="margin-bottom: var(--spacing-lg);">
            <div class="stat-card">
                <div class="stat-label">Total Compras</div>
                <div class="stat-value" id="totalCompras">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Despesas</div>
                <div class="stat-value" id="totalDespesas">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Pendentes</div>
                <div class="stat-value" id="totalPendentes">R$ 0,00</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Filtros</h3>
                <button class="btn btn-secondary" onclick="limparFiltros()">Limpar</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); padding: var(--spacing-md);">
                <select id="filtroTipo" onchange="carregarCompras()">
                    <option value="">Todos os tipos</option>
                    <option value="compra">Compras</option>
                    <option value="despesa">Despesas</option>
                </select>
                <select id="filtroStatus" onchange="carregarCompras()">
                    <option value="">Todos os status</option>
                    <option value="pendente">Pendente</option>
                    <option value="pago">Pago</option>
                    <option value="cancelado">Cancelado</option>
                </select>
                <select id="filtroFornecedor" onchange="carregarCompras()">
                    <option value="">Todos os fornecedores</option>
                </select>
            </div>
        </div>

        <div class="card" style="margin-top: var(--spacing-lg);">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Fornecedor</th>
                            <th>Material</th>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCompras">
                        <tr><td colspan="7" class="loading">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div class="modal" id="modalCompra">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tituloModal">Nova Compra/Despesa</h2>
                <button class="modal-close" onclick="fecharModal()">&times;</button>
            </div>
            <form id="formCompra">
                <input type="hidden" id="compraId">
                <div class="form-group">
                    <label>Fornecedor *</label>
                    <select id="fornecedorId" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Material/Descrição *</label>
                    <input type="text" id="material" required>
                </div>
                <div class="form-group">
                    <label>Tipo *</label>
                    <select id="tipo" required>
                        <option value="compra">Compra</option>
                        <option value="despesa">Despesa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valor (R$) *</label>
                    <input type="number" id="valor" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="status">
                        <option value="pendente">Pendente</option>
                        <option value="pago">Pago</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea id="observacoes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">Salvar</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/chat-widget.js"></script>
    <script src="/static/js/scanner-widget.js"></script>
    <script>
        let fornecedores = [];

        async function carregarPagina() {
            const user = await verificarAuth();
            if (!user) return;

            await carregarFornecedores();
            await carregarCompras();
            await carregarEstatisticas();
            await atualizarNotificacoes();
        }

        async function carregarFornecedores() {
            const response = await fetchAPI('/fornecedores');
            fornecedores = await response.json();
            
            const selectFornecedor = document.getElementById('fornecedorId');
            const filtroFornecedor = document.getElementById('filtroFornecedor');
            
            fornecedores.forEach(empresa => {
                const option1 = document.createElement('option');
                option1.value = fornecedor.id;
                option1.textContent = fornecedor.nome;
                selectFornecedor.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = fornecedor.id;
                option2.textContent = fornecedor.nome;
                filtroFornecedor.appendChild(option2);
            });
        }

        async function carregarCompras() {
            const filtroTipo = document.getElementById('filtroTipo').value;
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroFornecedor = document.getElementById('filtroFornecedor').value;

            let url = '/compras';
            const params = new URLSearchParams();
            if (filtroTipo) params.append('tipo', filtroTipo);
            if (filtroStatus) params.append('status', filtroStatus);
            if (filtroFornecedor) params.append('fornecedor_id', filtroFornecedor);
            
            if (params.toString()) url += '?' + params.toString();

            const response = await fetchAPI(url);
            const compras = await response.json();

            const tbody = document.getElementById('tabelaCompras');
            
            if (compras.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhuma compra registrada</td></tr>';
                return;
            }

            tbody.innerHTML = compras.map(compra => `
                <tr>
                    <td>${new Date(compra.data_compra).toLocaleDateString('pt-BR')}</td>
                    <td>${compra.fornecedor?.nome || 'N/A'}</td>
                    <td>${compra.material}</td>
                    <td><span class="badge ${compra.tipo === 'compra' ? 'badge-success' : 'badge-warning'}">${compra.tipo}</span></td>
                    <td>R$ ${compra.valor.toFixed(2)}</td>
                    <td><span class="badge ${getStatusBadgeClass(compra.status)}">${compra.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editarCompra(${compra.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletarCompra(${compra.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'pendente': 'badge-warning',
                'pago': 'badge-success',
                'cancelado': 'badge-danger'
            };
            return classes[status] || 'badge-secondary';
        }

        async function carregarEstatisticas() {
            const response = await fetchAPI('/compras');
            const compras = await response.json();

            const totalCompras = compras.filter(c => c.tipo === 'compra').reduce((acc, c) => acc + c.valor, 0);
            const totalDespesas = compras.filter(c => c.tipo === 'despesa').reduce((acc, c) => acc + c.valor, 0);
            const totalPendentes = compras.filter(c => c.status === 'pendente').reduce((acc, c) => acc + c.valor, 0);

            document.getElementById('totalCompras').textContent = `R$ ${totalCompras.toFixed(2)}`;
            document.getElementById('totalDespesas').textContent = `R$ ${totalDespesas.toFixed(2)}`;
            document.getElementById('totalPendentes').textContent = `R$ ${totalPendentes.toFixed(2)}`;
        }

        function abrirModalNovaCompra() {
            document.getElementById('tituloModal').textContent = 'Nova Compra/Despesa';
            document.getElementById('formCompra').reset();
            document.getElementById('compraId').value = '';
            document.getElementById('modalCompra').classList.add('active');
        }

        async function editarCompra(id) {
            const response = await fetchAPI(`/compras/${id}`);
            const compra = await response.json();

            document.getElementById('tituloModal').textContent = 'Editar Compra/Despesa';
            document.getElementById('compraId').value = compra.id;
            document.getElementById('fornecedorId').value = compra.fornecedor_id;
            document.getElementById('material').value = compra.material;
            document.getElementById('tipo').value = compra.tipo;
            document.getElementById('valor').value = compra.valor;
            document.getElementById('status').value = compra.status;
            document.getElementById('observacoes').value = compra.observacoes || '';

            document.getElementById('modalCompra').classList.add('active');
        }

        document.getElementById('formCompra').addEventListener('submit', async (e) => {
            e.preventDefault();

            const compraId = document.getElementById('compraId').value;
            const data = {
                fornecedor_id: parseInt(document.getElementById('fornecedorId').value),
                material: document.getElementById('material').value,
                tipo: document.getElementById('tipo').value,
                valor: parseFloat(document.getElementById('valor').value),
                status: document.getElementById('status').value,
                observacoes: document.getElementById('observacoes').value
            };

            try {
                if (compraId) {
                    await fetchAPI(`/compras/${compraId}`, { method: 'PUT', body: JSON.stringify(data) });
                    showNotification('Compra atualizada com sucesso!', 'success');
                } else {
                    await fetchAPI('/compras', { method: 'POST', body: JSON.stringify(data) });
                    showNotification('Compra registrada com sucesso!', 'success');
                }

                fecharModal();
                await carregarCompras();
                await carregarEstatisticas();
            } catch (error) {
                showNotification(error.message || 'Erro ao salvar compra', 'error');
            }
        });

        async function deletarCompra(id) {
            if (!confirm('Tem certeza que deseja excluir esta compra?')) return;

            try {
                await fetchAPI(`/compras/${id}`, { method: 'DELETE' });
                showNotification('Compra excluída com sucesso!', 'success');
                await carregarCompras();
                await carregarEstatisticas();
            } catch (error) {
                showNotification('Erro ao excluir compra', 'error');
            }
        }

        function fecharModal() {
            document.getElementById('modalCompra').classList.remove('active');
        }

        function limparFiltros() {
            document.getElementById('filtroTipo').value = '';
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroFornecedor').value = '';
            carregarCompras();
        }

        carregarPagina();
    </script>
</body>
</html>
