<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materiais e Preços - MRX Systems</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* Ajustes de espaçamento para header fixo e bottom nav */
        body {
            padding-bottom: 80px; /* Espaço para bottom nav em mobile */
        }

        main.container {
            padding-top: 80px; /* Espaço para header fixo */
            padding-bottom: 100px; /* Espaço para bottom nav */
        }

        /* Ajustes específicos para desktop */
        @media (min-width: 1024px) {
            main.container {
                padding-top: 90px; /* Header um pouco maior no desktop */
                padding-bottom: 100px; /* Mantém espaço para bottom nav */
            }
        }

        /* Garantir que modais não sejam cortados */
        .modal {
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .material-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border-left: 4px solid #059669;
        }
        
        .material-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        .material-card.leve {
            border-left-color: #10b981;
        }
        
        .material-card.medio {
            border-left-color: #f59e0b;
        }
        
        .material-card.pesado {
            border-left-color: #ef4444;
        }
        
        .material-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .material-title {
            flex: 1;
        }
        
        .material-codigo {
            font-size: 0.875rem;
            font-weight: 600;
            color: #059669;
            margin-bottom: 0.25rem;
        }
        
        .material-nome {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
            line-height: 1.4;
        }
        
        .material-classificacao {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }
        
        .material-classificacao.leve {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            box-shadow: 0 2px 4px rgba(5, 150, 105, 0.15);
        }
        
        .material-classificacao.medio {
            background: linear-gradient(135deg, #fde68a 0%, #fbbf24 100%);
            color: #78350f;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.25);
        }
        
        .material-classificacao.pesado {
            background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);
            color: #fef2f2;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.25);
        }
        
        .material-precos {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .precos-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .precos-grid {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .preco-item {
            flex: 1;
            min-width: 80px;
            text-align: center;
        }
        
        .preco-estrelas {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        
        .preco-valor {
            font-size: 1rem;
            font-weight: 700;
            color: #059669;
        }
        
        .preco-item.destaque-1 .preco-valor {
            color: #10b981;
        }
        
        .preco-item.destaque-2 .preco-valor {
            color: #f59e0b;
        }
        
        .preco-item.destaque-3 .preco-valor {
            color: #dc2626;
        }
        
        .material-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .filters-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .stats-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .stat-card {
            flex: 1;
            min-width: 150px;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content" style="justify-content: space-between;">
            <div class="logo">
                <img src="/static/images/mrx-logo.png" alt="MRX">
                <span>Materiais e Preços</span>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="notification-badge" onclick="window.location.href='/notificacoes.html'">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Sair</button>
            </div>
        </div>
    </header>

    <main class="container mt-4" style="padding-top: 80px; padding-bottom: 100px;">
        <div class="flex justify-between items-center mb-3" style="flex-wrap: wrap; gap: var(--spacing-md); margin-top: var(--spacing-md);">
            <h1 style="font-size: clamp(1.5rem, 6vw, 2rem);">Gestão de Materiais e Preços</h1>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="baixarModelo()" title="Baixar modelo de planilha">
                    <i class="fas fa-download"></i> Modelo
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('arquivoImportacao').click()" title="Importar materiais via Excel">
                    <i class="fas fa-file-excel"></i> Importar
                </button>
                <input type="file" id="arquivoImportacao" accept=".xlsx,.xls" style="display: none;" onchange="importarExcel(event)">
                <button class="btn btn-info" onclick="exportarExcel()" title="Exportar materiais e preços">
                    <i class="fas fa-file-export"></i> Exportar
                </button>
                <button class="btn btn-primary" onclick="abrirModalNovoMaterial()">+ Novo Material</button>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-value" id="totalMateriais">0</div>
                <div class="stat-label">Materiais Cadastrados</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
                <div class="stat-value" id="totalLeve">0</div>
                <div class="stat-label">Leve</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);">
                <div class="stat-value" id="totalMedio">0</div>
                <div class="stat-label">Médio</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
                <div class="stat-value" id="totalPesado">0</div>
                <div class="stat-label">Pesado</div>
            </div>
        </div>

        <div class="card">
            <div class="filters-row">
                <div class="filter-group">
                    <label><i class="fas fa-search"></i> Buscar Material</label>
                    <input type="text" id="filtroBusca" placeholder="Digite o nome ou código..." oninput="aplicarFiltros()">
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-filter"></i> Classificação</label>
                    <select id="filtroClassificacao" onchange="aplicarFiltros()">
                        <option value="">Todas</option>
                        <option value="leve">Leve</option>
                        <option value="medio">Médio</option>
                        <option value="pesado">Pesado</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="materiaisContainer">
            <div style="text-align: center; padding: 3rem; color: #6b7280;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                <p style="margin-top: 1rem;">Carregando materiais...</p>
            </div>
        </div>
    </main>

    <!-- Modal Material -->
    <div class="modal" id="modalMaterial">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="tituloModalMaterial">Novo Material</h2>
                <button class="modal-close" onclick="fecharModalMaterial()">&times;</button>
            </div>
            <form id="formMaterial">
                <input type="hidden" id="materialId">
                
                <div class="form-group">
                    <label>Nome do Material <span style="color: red;">*</span></label>
                    <input type="text" id="nomeMaterial" required placeholder="Ex: SUCATA PROCESSADOR CERÂMICO A">
                </div>

                <div class="form-group">
                    <label>Código <span style="font-size: 0.875rem; color: #6b7280;">(gerado automaticamente)</span></label>
                    <input type="text" id="codigoMaterial" placeholder="Será gerado automaticamente" readonly style="background-color: #f3f4f6; cursor: not-allowed;">
                </div>

                <div class="form-group">
                    <label>Classificação <span style="color: red;">*</span></label>
                    <select id="classificacaoMaterial" required>
                        <option value="">Selecione...</option>
                        <option value="leve">Leve</option>
                        <option value="medio">Médio</option>
                        <option value="pesado">Pesado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Descrição</label>
                    <textarea id="descricaoMaterial" rows="3" placeholder="Descrição detalhada do material"></textarea>
                </div>

                <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #10b981;">
                    <h4 style="margin: 0 0 1rem 0; color: #047857;">
                        <i class="fas fa-coins"></i> Tabela de Preços (R$/kg)
                    </h4>
                    <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #6b7280;">
                        Configure os preços para as 3 tabelas de estrelas
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #10b981;">
                                <i class="fas fa-star"></i> 1 Estrela
                            </label>
                            <input type="number" id="preco1Estrela" step="0.01" min="0" placeholder="0.00" required
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #10b981; border-radius: 6px; font-size: 1rem;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #f59e0b;">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i> 2 Estrelas
                            </label>
                            <input type="number" id="preco2Estrela" step="0.01" min="0" placeholder="0.00" required
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #f59e0b; border-radius: 6px; font-size: 1rem;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #dc2626;">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> 3 Estrelas
                            </label>
                            <input type="number" id="preco3Estrela" step="0.01" min="0" placeholder="0.00" required
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #dc2626; border-radius: 6px; font-size: 1rem;">
                        </div>
                    </div>
                    <p style="margin: 1rem 0 0 0; font-size: 0.85rem; color: #6b7280; font-style: italic;">
                        <i class="fas fa-info-circle"></i> Os preços devem ser progressivos: 1★ < 2★ < 3★
                    </p>
                </div>

                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalMaterial()" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;"><i class="fas fa-save"></i> Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Em Desenvolvimento -->
    <div class="modal" id="modalEmDesenvolvimento">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="border-bottom: none; padding-bottom: 0;">
                <span class="modal-close" onclick="fecharModalEmDesenvolvimento()">&times;</span>
            </div>
            <div style="text-align: center; padding: 2rem 1.5rem;">
                <div style="display: inline-block; padding: 1.5rem; background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 50%; margin-bottom: 1.5rem;">
                    <i class="fas fa-tools" style="font-size: 3rem; color: white;"></i>
                </div>
                <h2 style="margin-bottom: 1rem; color: #1f2937; font-size: 1.75rem;">Funcionalidade em Desenvolvimento</h2>
                <p style="color: #6b7280; font-size: 1.125rem; margin-bottom: 0.5rem; font-weight: 500;">Histórico de Materiais</p>
                <p style="color: #9ca3af; font-size: 0.95rem; line-height: 1.6; margin-bottom: 2rem;">
                    Esta funcionalidade está sendo desenvolvida e em breve estará disponível para uso. 
                    Agradecemos sua paciência!
                </p>
                <div style="display: flex; gap: 0.75rem; align-items: center; justify-content: center; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle" style="color: #059669; font-size: 1.25rem;"></i>
                    <p style="color: #4b5563; font-size: 0.875rem; margin: 0;">
                        Em caso de dúvidas, entre em contato com o suporte
                    </p>
                </div>
                <button class="btn btn-primary" onclick="fecharModalEmDesenvolvimento()" style="padding: 0.75rem 2rem; font-size: 1rem;">
                    <i class="fas fa-check"></i> Entendi
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav" id="navMenuMobile">
        <!-- Menus serão renderizados dinamicamente pelo RBAC -->
    </nav>

    <script>
        // Funções de autenticação necessárias
        function getToken() {
            return localStorage.getItem('token');
        }

        function removeToken() {
            localStorage.removeItem('token');
        }

        async function fetchAPI(endpoint, options = {}) {
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(`/api${endpoint}`, {
                ...options,
                headers
            });

            return response;
        }

        async function verificarAuth() {
            const token = getToken();
            if (!token) {
                window.location.href = '/';
                return null;
            }

            try {
                const response = await fetchAPI('/auth/me');
                if (!response.ok) {
                    removeToken();
                    window.location.href = '/';
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error('Erro ao verificar autenticação:', error);
                removeToken();
                window.location.href = '/';
                return null;
            }
        }

        function logout() {
            removeToken();
            window.location.href = '/';
        }
    </script>
    <script src="/static/js/rbac.js"></script>
    <script>
        let materiais = [];
        let materiaisFiltrados = [];
        let tabelas = [];

        function mostrarMensagem(mensagem, tipo = 'success') {
            alert(mensagem);
        }

        async function carregarTabelas() {
            try {
                const response = await fetch('/api/tabelas-preco', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar tabelas');

                tabelas = await response.json();
            } catch (error) {
                console.error('Erro ao carregar tabelas:', error);
            }
        }

        async function carregarMateriais() {
            try {
                const response = await fetch('/api/materiais-base?apenas_ativos=true', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar materiais');

                materiais = await response.json();
                aplicarFiltros();
                atualizarEstatisticas();
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao carregar materiais', 'error');
                document.getElementById('materiaisContainer').innerHTML = 
                    '<div style="text-align: center; padding: 3rem; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar materiais</p></div>';
            }
        }

        function aplicarFiltros() {
            const busca = document.getElementById('filtroBusca').value.toLowerCase();
            const classificacao = document.getElementById('filtroClassificacao').value;

            materiaisFiltrados = materiais.filter(material => {
                const matchBusca = !busca || 
                    material.nome.toLowerCase().includes(busca) || 
                    (material.codigo && material.codigo.toLowerCase().includes(busca));
                
                const matchClassificacao = !classificacao || material.classificacao === classificacao;

                return matchBusca && matchClassificacao;
            });

            renderizarMateriais();
        }

        function renderizarMateriais() {
            const container = document.getElementById('materiaisContainer');
            
            if (materiaisFiltrados.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <i class="fas fa-box-open" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Nenhum material encontrado</p>
                    </div>
                `;
                return;
            }

            const html = `<div class="materials-grid">${materiaisFiltrados.map(material => criarCardMaterial(material)).join('')}</div>`;
            container.innerHTML = html;
        }

        function criarCardMaterial(material) {
            const precos = material.precos || {};
            
            return `
                <div class="material-card ${material.classificacao}">
                    <div class="material-header">
                        <div class="material-title">
                            <div class="material-codigo">${material.codigo || 'N/A'}</div>
                            <h3 class="material-nome">${material.nome}</h3>
                            <span class="material-classificacao ${material.classificacao}">${material.classificacao}</span>
                        </div>
                    </div>
                    
                    ${material.descricao ? `<p style="font-size: 0.875rem; color: #6b7280; margin: 0.75rem 0;">${material.descricao}</p>` : ''}
                    
                    <div class="material-precos">
                        <div class="precos-label"><i class="fas fa-coins"></i> Preços (R$/kg)</div>
                        <div class="precos-grid">
                            <div class="preco-item destaque-1">
                                <div class="preco-estrelas"><i class="fas fa-star"></i> 1★</div>
                                <div class="preco-valor">R$ ${parseFloat(precos['preco_1_estrela'] || 0).toFixed(2)}</div>
                            </div>
                            <div class="preco-item destaque-2">
                                <div class="preco-estrelas"><i class="fas fa-star"></i><i class="fas fa-star"></i> 2★</div>
                                <div class="preco-valor">R$ ${parseFloat(precos['preco_2_estrela'] || 0).toFixed(2)}</div>
                            </div>
                            <div class="preco-item destaque-3">
                                <div class="preco-estrelas"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> 3★</div>
                                <div class="preco-valor">R$ ${parseFloat(precos['preco_3_estrela'] || 0).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="material-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editarMaterial(${material.id})" style="flex: 1;">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-info" onclick="verHistorico(${material.id})" style="flex: 1;">
                            <i class="fas fa-history"></i> Histórico
                        </button>
                    </div>
                </div>
            `;
        }

        function atualizarEstatisticas() {
            document.getElementById('totalMateriais').textContent = materiais.length;
            document.getElementById('totalLeve').textContent = materiais.filter(m => m.classificacao === 'leve').length;
            document.getElementById('totalMedio').textContent = materiais.filter(m => m.classificacao === 'medio').length;
            document.getElementById('totalPesado').textContent = materiais.filter(m => m.classificacao === 'pesado').length;
        }

        function abrirModalNovoMaterial() {
            document.getElementById('tituloModalMaterial').textContent = 'Novo Material';
            document.getElementById('formMaterial').reset();
            document.getElementById('materialId').value = '';
            document.getElementById('modalMaterial').style.display = 'flex';
        }

        function fecharModalMaterial() {
            document.getElementById('modalMaterial').style.display = 'none';
        }

        async function editarMaterial(id) {
            const material = materiais.find(m => m.id === id);
            if (!material) return;

            document.getElementById('tituloModalMaterial').textContent = 'Editar Material';
            document.getElementById('materialId').value = material.id;
            document.getElementById('nomeMaterial').value = material.nome;
            document.getElementById('codigoMaterial').value = material.codigo || '';
            document.getElementById('classificacaoMaterial').value = material.classificacao;
            document.getElementById('descricaoMaterial').value = material.descricao || '';
            
            const precos = material.precos || {};
            document.getElementById('preco1Estrela').value = precos['preco_1_estrela'] || '';
            document.getElementById('preco2Estrela').value = precos['preco_2_estrela'] || '';
            document.getElementById('preco3Estrela').value = precos['preco_3_estrela'] || '';
            
            document.getElementById('modalMaterial').style.display = 'flex';
        }

        function verHistorico(id) {
            document.getElementById('modalEmDesenvolvimento').style.display = 'flex';
        }

        function fecharModalEmDesenvolvimento() {
            document.getElementById('modalEmDesenvolvimento').style.display = 'none';
        }

        document.getElementById('formMaterial').addEventListener('submit', async (e) => {
            e.preventDefault();

            const materialId = document.getElementById('materialId').value;
            const preco1 = parseFloat(document.getElementById('preco1Estrela').value) || 0;
            const preco2 = parseFloat(document.getElementById('preco2Estrela').value) || 0;
            const preco3 = parseFloat(document.getElementById('preco3Estrela').value) || 0;

            if (isNaN(preco1) || isNaN(preco2) || isNaN(preco3)) {
                mostrarMensagem('Por favor, preencha todos os preços com valores válidos', 'error');
                return;
            }

            if (preco1 <= 0 || preco2 <= 0 || preco3 <= 0) {
                mostrarMensagem('Todos os preços devem ser maiores que zero', 'error');
                return;
            }

            if (preco1 >= preco2 || preco2 >= preco3) {
                mostrarMensagem('Os preços devem ser progressivos: 1★ < 2★ < 3★', 'error');
                return;
            }
            
            const dados = {
                nome: document.getElementById('nomeMaterial').value,
                classificacao: document.getElementById('classificacaoMaterial').value,
                descricao: document.getElementById('descricaoMaterial').value,
                precos: {
                    preco_1_estrela: preco1,
                    preco_2_estrela: preco2,
                    preco_3_estrela: preco3
                }
            };

            try {
                const url = materialId ? `/api/materiais-base/${materialId}` : '/api/materiais-base';
                const method = materialId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || 'Erro ao salvar');
                }

                mostrarMensagem(materialId ? 'Material atualizado com sucesso!' : 'Material criado com sucesso!');
                fecharModalMaterial();
                await carregarMateriais();
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem(error.message, 'error');
            }
        });

        async function baixarModelo() {
            try {
                const response = await fetch('/api/materiais-base/modelo-importacao', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao baixar modelo');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `modelo_importacao_materiais_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                mostrarMensagem('Modelo baixado com sucesso!');
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao baixar modelo', 'error');
            }
        }

        async function importarExcel(event) {
            const arquivo = event.target.files[0];
            if (!arquivo) return;

            if (!arquivo.name.endsWith('.xlsx') && !arquivo.name.endsWith('.xls')) {
                mostrarMensagem('Por favor, selecione um arquivo Excel (.xlsx ou .xls)', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('arquivo', arquivo);

            try {
                mostrarMensagem('Importando dados... Por favor aguarde.', 'info');
                
                const response = await fetch('/api/materiais-base/importar-excel', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                const resultado = await response.json();

                if (!response.ok) {
                    throw new Error(resultado.erro || 'Erro ao importar arquivo');
                }

                let mensagem = `Importação concluída!\n`;
                mensagem += `Materiais criados: ${resultado.materiais_criados}\n`;
                mensagem += `Materiais atualizados: ${resultado.materiais_atualizados}\n`;
                mensagem += `Preços criados: ${resultado.precos_criados || 0}`;
                
                if (resultado.erros && resultado.erros.length > 0) {
                    mensagem += `\n\nErros encontrados:\n${resultado.erros.slice(0, 5).join('\n')}`;
                    if (resultado.erros.length > 5) {
                        mensagem += `\n... e mais ${resultado.erros.length - 5} erros`;
                    }
                }

                alert(mensagem);
                carregarMateriais();
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem(error.message, 'error');
            } finally {
                event.target.value = '';
            }
        }

        async function exportarExcel() {
            try {
                const response = await fetch('/api/materiais-base/exportar-excel', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao exportar');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `materiais_precos_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                mostrarMensagem('Dados exportados com sucesso!');
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao exportar dados', 'error');
            }
        }

        window.addEventListener('click', (e) => {
            if (e.target === document.getElementById('modalMaterial')) {
                fecharModalMaterial();
            }
        });

        async function inicializar() {
            await carregarTabelas();
            await carregarMateriais();
        }

        // Inicializar RBAC e menus primeiro
        document.addEventListener('DOMContentLoaded', async () => {
            await inicializarRBAC();
            await inicializar();
        });
    </script>
</body>
</html>
