<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autorizações de Preço - MRX Systems</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .autorizacao-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #f59e0b;
        }
        
        .autorizacao-card.aprovada {
            border-left-color: #10b981;
            opacity: 0.7;
        }
        
        .autorizacao-card.rejeitada {
            border-left-color: #ef4444;
            opacity: 0.7;
        }
        
        .autorizacao-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .status-badge.pendente {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.aprovada {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-badge.rejeitada {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-weight: 600;
            color: #1f2937;
        }
        
        .preco-comparacao {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            border-radius: 8px;
        }
        
        .preco-box {
            text-align: center;
        }
        
        .preco-label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .preco-valor {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .preco-diferenca {
            margin-top: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: #dc2626;
        }
        
        .decisao-panel {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1rem 0;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .radio-option:hover {
            border-color: #059669;
            background: #f0fdf4;
        }
        
        .radio-option input[type="radio"] {
            margin-right: 0.75rem;
        }
        
        .radio-option input[type="radio"]:checked + label {
            font-weight: 600;
            color: #059669;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }
        
        .stat-card.danger {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content" style="justify-content: space-between;">
            <div class="logo">
                <img src="/static/images/mrx-logo.png" alt="MRX">
                <span>Autorizações de Preço</span>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="notification-badge" onclick="window.location.href='/notificacoes.html'">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Sair</button>
            </div>
        </div>
    </header>

    <nav class="bottom-nav">
        <a href="/administracao.html" class="bottom-nav-item">
            <i class="fas fa-cog icon"></i>
            <span>Administração</span>
        </a>
        <a href="/dashboard.html" class="bottom-nav-item">
            <i class="fas fa-chart-line icon"></i>
            <span>Dashboard</span>
        </a>
        <div class="fab-container">
            <button class="fab-button" onclick="window.location.href='/funcionario.html'" aria-label="Nova Solicitação">
                <i class="fas fa-plus icon"></i>
            </button>
        </div>
        <a href="/solicitacoes.html" class="bottom-nav-item">
            <i class="fas fa-file-alt icon"></i>
            <span>Compra</span>
        </a>
        <a href="/fornecedores.html" class="bottom-nav-item">
            <i class="fas fa-building icon"></i>
            <span>Fornecedores</span>
        </a>
    </nav>

    <main class="container mt-4" style="padding-bottom: 3rem;">
        <h1 style="margin-bottom: 1.5rem;"><i class="fas fa-shield-alt"></i> Autorizações de Preço</h1>

        <div class="stats-bar">
            <div class="stat-card warning">
                <div class="stat-value" id="statPendentes">0</div>
                <div class="stat-label">Pendentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statAprovadas">0</div>
                <div class="stat-label">Aprovadas</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-value" id="statRejeitadas">0</div>
                <div class="stat-label">Rejeitadas</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">Total</div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div class="form-group" style="margin: 0;">
                    <label>Status</label>
                    <select id="filtroStatus" onchange="aplicarFiltros()">
                        <option value="">Todos</option>
                        <option value="pendente" selected>Pendentes</option>
                        <option value="aprovada">Aprovadas</option>
                        <option value="rejeitada">Rejeitadas</option>
                    </select>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label>Comprador</label>
                    <select id="filtroComprador" onchange="aplicarFiltros()">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label>Ordenar por</label>
                    <select id="filtroOrdem" onchange="aplicarFiltros()">
                        <option value="recente">Mais recentes</option>
                        <option value="antigo">Mais antigas</option>
                        <option value="valor">Maior diferença</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="listaAutorizacoes">
            <div style="text-align: center; padding: 3rem; color: #6b7280;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                <p style="margin-top: 1rem;">Carregando autorizações...</p>
            </div>
        </div>
    </main>

    <!-- Modal de Decisão -->
    <div class="modal" id="modalDecisao">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2><i class="fas fa-gavel"></i> Analisar Solicitação</h2>
                <button class="modal-close" onclick="fecharModalDecisao()">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        let autorizacoes = [];
        let autorizacoesFiltradas = [];
        let compradores = [];
        let socket = null;

        async function carregarAutorizacoes() {
            try {
                const response = await fetch('/api/autorizacoes-preco', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar autorizações');

                autorizacoes = await response.json();
                await carregarCompradores();
                aplicarFiltros();
                atualizarEstatisticas();
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('listaAutorizacoes').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem;"></i>
                        <p style="margin-top: 1rem;">Erro ao carregar autorizações</p>
                    </div>
                `;
            }
        }

        async function carregarCompradores() {
            const compradoresUnicos = [...new Set(autorizacoes.map(a => a.comprador_nome))];
            const select = document.getElementById('filtroComprador');
            select.innerHTML = '<option value="">Todos</option>' +
                compradoresUnicos.map(nome => `<option value="${nome}">${nome}</option>`).join('');
        }

        function aplicarFiltros() {
            const status = document.getElementById('filtroStatus').value;
            const comprador = document.getElementById('filtroComprador').value;
            const ordem = document.getElementById('filtroOrdem').value;

            autorizacoesFiltradas = autorizacoes.filter(auth => {
                const matchStatus = !status || auth.status === status;
                const matchComprador = !comprador || auth.comprador_nome === comprador;
                return matchStatus && matchComprador;
            });

            if (ordem === 'recente') {
                autorizacoesFiltradas.sort((a, b) => new Date(b.data_solicitacao) - new Date(a.data_solicitacao));
            } else if (ordem === 'antigo') {
                autorizacoesFiltradas.sort((a, b) => new Date(a.data_solicitacao) - new Date(b.data_solicitacao));
            } else if (ordem === 'valor') {
                autorizacoesFiltradas.sort((a, b) => parseFloat(b.diferenca_percentual) - parseFloat(a.diferenca_percentual));
            }

            renderizarAutorizacoes();
        }

        function renderizarAutorizacoes() {
            const container = document.getElementById('listaAutorizacoes');

            if (autorizacoesFiltradas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <i class="fas fa-check-circle" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Nenhuma autorização encontrada</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = autorizacoesFiltradas.map(auth => criarCardAutorizacao(auth)).join('');
        }

        function criarCardAutorizacao(auth) {
            const dataFormatada = new Date(auth.data_solicitacao).toLocaleString('pt-BR');
            const diferenca = parseFloat(auth.diferenca_percentual || 0);

            return `
                <div class="autorizacao-card ${auth.status}">
                    <div class="autorizacao-header">
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0;">
                                <i class="fas fa-hashtag"></i> Solicitação #${auth.id}
                            </h3>
                            <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">
                                <i class="fas fa-clock"></i> ${dataFormatada}
                            </p>
                        </div>
                        <span class="status-badge ${auth.status}">
                            ${auth.status === 'pendente' ? '<i class="fas fa-hourglass-half"></i> AGUARDANDO' : ''}
                            ${auth.status === 'aprovada' ? '<i class="fas fa-check"></i> APROVADA' : ''}
                            ${auth.status === 'rejeitada' ? '<i class="fas fa-times"></i> REJEITADA' : ''}
                        </span>
                    </div>

                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-user"></i> Comprador</span>
                            <span class="info-value">${auth.comprador_nome || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-building"></i> Fornecedor</span>
                            <span class="info-value">${auth.fornecedor_nome || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-star"></i> Tabela Atual</span>
                            <span class="info-value">${auth.tabela_atual_estrelas || 1}★</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-box"></i> Material</span>
                            <span class="info-value">${auth.material_nome || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-weight"></i> Peso</span>
                            <span class="info-value">${parseFloat(auth.peso_kg || 0).toFixed(2)} kg</span>
                        </div>
                    </div>

                    <div class="preco-comparacao">
                        <div class="preco-box">
                            <div class="preco-label"><i class="fas fa-table"></i> Preço Tabela</div>
                            <div class="preco-valor" style="color: #10b981;">R$ ${parseFloat(auth.preco_tabela || 0).toFixed(2)}</div>
                        </div>
                        <div class="preco-box">
                            <div class="preco-label"><i class="fas fa-handshake"></i> Preço Negociado</div>
                            <div class="preco-valor" style="color: #dc2626;">R$ ${parseFloat(auth.preco_negociado || 0).toFixed(2)}</div>
                        </div>
                        <div class="preco-box">
                            <div class="preco-label"><i class="fas fa-chart-line"></i> Diferença</div>
                            <div class="preco-diferenca">+${diferenca.toFixed(1)}%</div>
                        </div>
                    </div>

                    ${auth.justificativa ? `
                        <div style="background: white; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="margin: 0; font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">
                                <i class="fas fa-comment"></i> Justificativa
                            </p>
                            <p style="margin: 0; font-style: italic;">"${auth.justificativa}"</p>
                        </div>
                    ` : ''}

                    ${auth.status === 'pendente' ? `
                        <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem;">
                            <button class="btn btn-success" onclick="abrirModalDecisao(${auth.id})" style="flex: 1;">
                                <i class="fas fa-gavel"></i> Analisar
                            </button>
                        </div>
                    ` : auth.status === 'aprovada' ? `
                        <div style="background: #d1fae5; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="margin: 0; color: #065f46; font-weight: 600;">
                                <i class="fas fa-check-circle"></i> Aprovada ${auth.nova_tabela_atribuida_nome ? `- Fornecedor promovido para ${auth.nova_tabela_atribuida_estrelas}★` : ''}
                            </p>
                            ${auth.motivo_decisao ? `<p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">"${auth.motivo_decisao}"</p>` : ''}
                        </div>
                    ` : `
                        <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="margin: 0; color: #991b1b; font-weight: 600;">
                                <i class="fas fa-times-circle"></i> Rejeitada
                            </p>
                            ${auth.motivo_decisao ? `<p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">"${auth.motivo_decisao}"</p>` : ''}
                        </div>
                    `}
                </div>
            `;
        }

        function atualizarEstatisticas() {
            const pendentes = autorizacoes.filter(a => a.status === 'pendente').length;
            const aprovadas = autorizacoes.filter(a => a.status === 'aprovada').length;
            const rejeitadas = autorizacoes.filter(a => a.status === 'rejeitada').length;

            document.getElementById('statPendentes').textContent = pendentes;
            document.getElementById('statAprovadas').textContent = aprovadas;
            document.getElementById('statRejeitadas').textContent = rejeitadas;
            document.getElementById('statTotal').textContent = autorizacoes.length;
        }

        async function abrirModalDecisao(id) {
            const auth = autorizacoes.find(a => a.id === id);
            if (!auth) return;

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                ${criarCardAutorizacao(auth)}
                
                <div class="decisao-panel">
                    <h3 style="margin: 0 0 1rem 0;"><i class="fas fa-gavel"></i> Tomar Decisão</h3>
                    
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="decisao" value="aprovar" checked>
                            <span><i class="fas fa-check"></i> Aprovar sem promoção (mantém tabela ${auth.tabela_atual_estrelas || 1}★)</span>
                        </label>
                        ${auth.tabela_atual_estrelas < 3 ? `
                            <label class="radio-option">
                                <input type="radio" name="decisao" value="promover">
                                <span><i class="fas fa-level-up-alt"></i> Aprovar e promover fornecedor para ${(auth.tabela_atual_estrelas || 1) + 1}★</span>
                            </label>
                        ` : ''}
                        <label class="radio-option">
                            <input type="radio" name="decisao" value="rejeitar">
                            <span><i class="fas fa-times"></i> Rejeitar solicitação</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label>Motivo da decisão</label>
                        <textarea id="motivoDecisao" rows="3" placeholder="Descreva o motivo da sua decisão..."></textarea>
                    </div>

                    <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                        <button class="btn btn-secondary" onclick="fecharModalDecisao()" style="flex: 1;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn btn-success" onclick="processarDecisao(${id})" style="flex: 1;">
                            <i class="fas fa-check"></i> Confirmar Decisão
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('modalDecisao').style.display = 'flex';
        }

        function fecharModalDecisao() {
            document.getElementById('modalDecisao').style.display = 'none';
        }

        async function processarDecisao(id) {
            const decisao = document.querySelector('input[name="decisao"]:checked').value;
            const motivo = document.getElementById('motivoDecisao').value;

            try {
                if (decisao === 'rejeitar') {
                    await rejeitarAutorizacao(id, motivo);
                } else {
                    await aprovarAutorizacao(id, decisao === 'promover', motivo);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao processar decisão: ' + error.message);
            }
        }

        async function aprovarAutorizacao(id, promover, motivo) {
            const auth = autorizacoes.find(a => a.id === id);
            const novaTabela = promover ? (auth.tabela_atual_id || 1) + 1 : null;

            const response = await fetch(`/api/autorizacoes-preco/${id}/aprovar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    promover_fornecedor: promover,
                    nova_tabela_id: novaTabela,
                    motivo_decisao: motivo
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.erro || 'Erro ao aprovar');
            }

            alert(promover ? 
                'Autorização aprovada e fornecedor promovido com sucesso!' : 
                'Autorização aprovada com sucesso!');
            
            fecharModalDecisao();
            await carregarAutorizacoes();
        }

        async function rejeitarAutorizacao(id, motivo) {
            if (!motivo.trim()) {
                alert('Por favor, informe o motivo da rejeição');
                return;
            }

            const response = await fetch(`/api/autorizacoes-preco/${id}/rejeitar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    motivo_decisao: motivo
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.erro || 'Erro ao rejeitar');
            }

            alert('Autorização rejeitada com sucesso!');
            fecharModalDecisao();
            await carregarAutorizacoes();
        }

        window.addEventListener('click', (e) => {
            if (e.target === document.getElementById('modalDecisao')) {
                fecharModalDecisao();
            }
        });

        function inicializarWebSocket() {
            const token = localStorage.getItem('token');
            if (!token) return;

            socket = io('/', {
                auth: {
                    token: token
                },
                transports: ['websocket', 'polling']
            });

            socket.on('connect', function() {
                console.log('WebSocket conectado - aguardando notificações');
            });

            socket.on('nova_autorizacao_preco', function(data) {
                console.log('Nova autorização recebida:', data);
                
                mostrarNotificacaoToast(
                    `Nova Autorização #${data.autorizacao_id}`,
                    `${data.comprador} solicitou autorização para ${data.material} (${data.fornecedor}) - +${data.diferenca_percentual.toFixed(1)}%`
                );
                
                carregarAutorizacoes();
            });

            socket.on('disconnect', function() {
                console.log('WebSocket desconectado');
            });

            socket.on('connect_error', function(error) {
                console.error('Erro de conexão WebSocket:', error);
            });
        }

        function mostrarNotificacaoToast(titulo, mensagem) {
            if (Notification.permission === 'granted') {
                new Notification(titulo, {
                    body: mensagem,
                    icon: '/static/images/mrx-logo.png',
                    badge: '/static/images/mrx-logo.png',
                    tag: 'autorizacao-preco'
                });
            }
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                z-index: 10000;
                min-width: 300px;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;
            toast.innerHTML = `
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <i class="fas fa-bell" style="font-size: 1.5rem;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; margin-bottom: 0.25rem;">${titulo}</div>
                        <div style="font-size: 0.875rem; opacity: 0.95;">${mensagem}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.25rem; cursor: pointer; padding: 0;">
                        &times;
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        if (Notification.permission === 'default') {
            Notification.requestPermission();
        }

        carregarAutorizacoes();
        inicializarWebSocket();
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
