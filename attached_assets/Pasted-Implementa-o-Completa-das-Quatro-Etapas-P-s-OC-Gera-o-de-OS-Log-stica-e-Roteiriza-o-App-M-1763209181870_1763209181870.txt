ImplementaÃ§Ã£o Completa das Quatro Etapas (PÃ³s-OC)

(GeraÃ§Ã£o de OS â†’ LogÃ­stica e RoteirizaÃ§Ã£o â†’ App Motorista â†’ ConferÃªncia na Chegada)

Utilize este prompt como instruÃ§Ã£o de implementaÃ§Ã£o.
NÃ£o gere cÃ³digo agora; gere tela, endpoints, modelos e lÃ³gica conforme descrito.

ğŸ”µ Contexto Geral para a IA (deve ser lido antes de executar):

O sistema MRX_GestÃ£o jÃ¡ estÃ¡ com:

SolicitaÃ§Ã£o de Compra (SC) funcionando

AprovaÃ§Ã£o de SC por ADM

ConversÃ£o de SC em OC

Tela bÃ¡sica de listagem e aprovaÃ§Ã£o/reprovaÃ§Ã£o de OC

A partir daqui, vocÃª deve implementar o fluxo completo de logÃ­stica, exatamente como o documento MRX_GestÃ£o especifica (cadastro de motorista, veÃ­culos, OS, rotas, checkpoints, conferÃªncia, lote).

ğŸŸ¦ Tarefa 1 â€” Compra: Recebimento e IntegraÃ§Ã£o com LogÃ­stica (GeraÃ§Ã£o de OS)

Implemente GeraÃ§Ã£o de OS (Ordem de ServiÃ§o) vinculada a uma OC aprovada.

ğŸ¯ Objetivo

ApÃ³s OC aprovada, o sistema deve permitir criar uma OS completa, definindo:

previsÃ£o de coleta/entrega

motorista

veÃ­culo

rota (pontos, ordem, tipo)

status operacional

auditoria completa com GPS

ğŸ§± MODELAGEM (ObrigatÃ³ria)

Criar entidade OrdemServico (OS) com:

Campo	DescriÃ§Ã£o
id	UUID
oc_id	FK OC
numero_os	sequencial
fornecedor_snapshot	nome, CNPJ, endereÃ§o
tipo	COLETA ou ENTREGA
janela_coleta	inÃ­cio/fim
motorista_id	FK Motorista
veiculo_id	FK VeÃ­culo
rota[]	[{ordem, endereÃ§o, lat, lon, observacao, tipo_ponto}]
status	PENDENTE, AGENDADA, EM_ROTA, NO_FORNECEDOR, COLETADO, A_CAMINHO_MATRIZ, ENTREGUE, FINALIZADA, CANCELADA
gps_logs[]	timeline de eventos GPS
attachments	fotos, documentos
created_by	user_id
auditoria	trilha completa
ğŸ”— ENDPOINTS OBRIGATÃ“RIOS

POST /oc/{id}/gerar-os

cria OS vinculada

gera nÃºmero sequencial

snapshot do fornecedor

status inicial: PENDENTE

GET /os/{id}

detalhes completos (rota, logs, status, motorista etc.)

GET /os

filtros: status, data, motorista, OC, fornecedor

PUT /os/{id}/atribuir-motorista

motorista_id

veiculo_id

registra auditoria e envia notificaÃ§Ã£o

POST /os/{id}/reagendar

nova janela

motivo obrigatÃ³rio

auditoria

ğŸ“ REGRAS DE NEGÃ“CIO (ObrigatÃ³rias)

OS sÃ³ pode ser criada se OC.status = APROVADA

GeraÃ§Ã£o automÃ¡tica de notificaÃ§Ã£o ao motorista quando atribuÃ­do

Ao motorista aceitar, gravar snapshot GPS obrigatÃ³rio

Permitir reagendamento mantendo histÃ³rico

Manter trilha de auditoria completa (IP/GPS/device/usuÃ¡rio)

ğŸ–¥ UI WEB (Painel Administrativo / LogÃ­stica)

Criar:

â¤ Novo card â€œLogÃ­sticaâ€ no menu administrativo

Dentro dele:

Tela: Gerenciar OS

tabela com filtros por status

botÃ£o â€œGerar OSâ€ dentro do detalhe da OC

botÃ£o â€œAtribuir Motoristaâ€

indicador de atraso por janela

abrir OS em modal detalhada

Tela: Agenda / CalendÃ¡rio

calendÃ¡rio com janelas de coleta

arrastar e soltar para reagendar OS

âœ” CritÃ©rios de aceite

OS vinculada a OC criada com todos os campos obrigatÃ³rios

Dashboard LogÃ­stica mostra todas as OS

NotificaÃ§Ã£o enviada ao motorista ao atribuir

Auditoria registrada corretamente

ğŸŸ© Tarefa 2 â€” LogÃ­stica: OS + RoteirizaÃ§Ã£o
ğŸ¯ Objetivo

Implementar o mÃ³dulo de logÃ­stica completo:

roteirizaÃ§Ã£o

agrupamento de rotas por proximidade

visÃ£o Kanban das OS

histÃ³rico GPS por OS

eventos operacionais

ğŸ§± MODELOS / ENTIDADES

Adicionar:

RotaOperacional

os_id

motorista_id

veiculo_id

pontos[]

km_estimado

km_real (preencher apÃ³s finalizaÃ§Ã£o)

GPSLog

os_id

evento (start, arrive, collect, leave, finish)

lat/lon

precisÃ£o

timestamp

device_id

ip

ğŸ”— ENDPOINTS ADICIONAIS
PUT /os/{id}/iniciar-rota

motorista sÃ³ pode iniciar se GPS ativo

grava evento + GPS

POST /os/{id}/evento

Payload:

{
  evento: "CHEGUEI" | "COLETEI" | "SAI" | "FINALIZEI",
  gps: {...},
  foto: (opcional),
  observacao: (opcional)
}

ğŸ“ LÃ“GICA DE ROTEIRIZAÃ‡ÃƒO

Implementar:

Clustering simples para agrupar pontos por proximidade

OrdenaÃ§Ã£o automÃ¡tica da rota (ex. Nearest-Neighbor)

Tela com mapa exibindo sequÃªncia da rota

Possibilidade de reordenar manualmente arrastando itens

ğŸ–¥ UI WEB LOGÃSTICA â€” OBRIGATÃ“RIA
â¤ Tela Kanban

Colunas:

PENDENTE

AGENDADA

EM ROTA

ENTREGUE

FINALIZADA

CANCELADA

Itens arrastÃ¡veis entre colunas (respeitando restriÃ§Ãµes de fluxo).

â¤ Tela Mapa / RoteirizaÃ§Ã£o

mapa com rotas por cor

motorista e veÃ­culo atribuÃ­do

tempo estimado por rota

botÃ£o â€œGerar Rota AutomÃ¡ticaâ€

âœ” CritÃ©rios de aceite

Rota gerada com agrupamento por proximidade

Mapa exibindo rotas

Eventos alterando status da OS corretamente

Timeline de GPS visÃ­vel na OS

ğŸŸ¨ Tarefa 3 â€” App Motorista (Mobile)
ğŸ¯ Objetivo

Criar o mÃ³dulo mobile (ou PWA mobile-first) para motoristas operarem a OS.

ğŸ“± Telas obrigatÃ³rias
Tela 1 â€” Login Motorista

AutenticaÃ§Ã£o por token

Captura automÃ¡tica de device_id

Tela 2 â€” Minhas OS

Lista por status (PENDENTE, AGENDADA, EM ROTA, FINALIZADA)

Mostrar:

NÂº OS

Fornecedor

Janela

DistÃ¢ncia atual atÃ© o fornecedor

Tela 3 â€” Detalhe da OS

rota completa

fotos associadas

pontos da rota

status da OS

botÃµes operacionais (condicionais a status):

Aceitar

Iniciar rota

Cheguei

Coletado

Cheguei MRX

Finalizar

Tela 4 â€” Comprovantes

tirar foto (compressÃ£o obrigatÃ³ria)

upload assÃ­ncrono

assinatura digital

ğŸ“ Regras ObrigatÃ³rias

Motorista sÃ³ pode ver OS atribuÃ­das ao seu id

Para INICIAR ROTA â†’ GPS obrigatÃ³rio

Toda aÃ§Ã£o grava:

GPS (lat/lon)

device_id

IP

timestamp

opcional: foto

Modo offline obrigatÃ³rio:

eventos pendentes ficam em fila

sincronizam quando online

SeguranÃ§a:

motorista nÃ£o pode alterar rota

motorista nÃ£o pode ver OS de outros

dados sensÃ­veis criptografados em trÃ¢nsito

âœ” CritÃ©rios de aceite

Motorista finaliza OS sem travar em nenhuma etapa

Eventos sincronizam mesmo em offline

Todas evidÃªncias (GPS/foto/assinatura) gravadas

Linha do tempo visÃ­vel na interface web

ğŸŸ¥ Tarefa 4 â€” ConferÃªncia na Chegada
ğŸ¯ Objetivo

Implementar o mÃ³dulo de RecepÃ§Ã£o e ConferÃªncia usado pelos conferentes ao material chegar na matriz.

Este mÃ³dulo inicia automaticamente quando:

OS.status muda para ENTREGUE_MATRIZ ou FINALIZADA (quando o motorista finaliza coleta)

ğŸ§± MODELO: ConferenciaRecebimento

Campos:

Campo	DescriÃ§Ã£o
id	UUID
os_id	FK
oc_id	FK
peso_fornecedor	(snap da OC)
peso_real	informado pelo conferente
fotos_pesagem[]	evidÃªncias
qualidade	classificaÃ§Ã£o
divergencia	bool
tipo_divergencia	PESO / QUALIDADE / ITENS
percentual_diferenca	automÃ¡tico
conferencia_status	PENDENTE / DIVERGENTE / AGUARDANDO_ADM / APROVADA / REJEITADA
conferente_id	usuÃ¡rio
auditoria	trilha completa
ğŸ”— ENDPOINTS
POST /conferencia/{os_id}/iniciar

gera registro de conferÃªncia

status inicial: PENDENTE

PUT /conferencia/{id}/registrar-pesagem

peso_real

fotos

qualidade

divergÃªncias

PUT /conferencia/{id}/enviar-para-adm

quando divergÃªncia > limite configurado

PUT /conferencia/{id}/decisao-adm

aÃ§Ãµes:

ACEITAR

ACEITAR_COM_DESCONTO

REJEITAR

registrar motivo e auditoria

POST /estoque/entrada

gerado automaticamente apÃ³s conferÃªncia aprovada

cria Lote seguindo regras do MRX_GestÃ£o

ğŸ–¥ UI WEB â€” ConferÃªncia

Criar nova seÃ§Ã£o no painel administrativo: â€œRecebimento / ConferÃªnciaâ€
Com telas:

1 â€” Lista de Recebimentos Pendentes

origem (fornecedor)

OS

OC

peso previsto

peso real (quando houver)

status da conferÃªncia

2 â€” Tela de ConferÃªncia

formulÃ¡rio de pesagem

qualidade

fotos

divergÃªncias

envio para ADM (se necessÃ¡rio)

3 â€” Tela ADM (decisÃ£o sobre divergÃªncia)

mostrar valores previstos vs recebidos

mostrar fotos e histÃ³rico

botÃµes: ACEITAR / ACEITAR COM DESCONTO / REJEITAR

âœ” CritÃ©rios de aceite

Conferente consegue registrar tudo sem brechas

DivergÃªncias abrem fluxo ADM corretamente

Lote criado automaticamente apÃ³s aprovaÃ§Ã£o

Auditoria completa gravada

Estoque atualizado com custo mÃ©dio ponderado