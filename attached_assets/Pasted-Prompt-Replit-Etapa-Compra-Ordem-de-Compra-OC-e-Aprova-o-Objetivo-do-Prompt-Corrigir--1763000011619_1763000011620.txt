Prompt Replit â€” Etapa: Compra â†’ Ordem de Compra (OC) e AprovaÃ§Ã£o
ğŸ¯ **Objetivo do Prompt**
Corrigir e expandir o mÃ³dulo de **SolicitaÃ§Ãµes de Compra** existente em Flask (rota `/solicitacoes.html`) para implementar totalmente a prÃ³xima etapa do fluxo: **Ordem de Compra (OC)** e **AprovaÃ§Ã£o**, conforme o blueprint tÃ©cnico do sistema MRX_GestÃ£o.

O sistema jÃ¡ possui:
- MÃ³dulo de SolicitaÃ§Ã£o de Compra funcional (SC),
- Cadastros de Fornecedores e Produtos/Lotes,
- Banco de dados ativo,
- Rota `/solicitacoes.html` com erros na renderizaÃ§Ã£o.

Este prompt deve garantir o funcionamento completo da geraÃ§Ã£o, aprovaÃ§Ã£o e rastreabilidade das **Ordens de Compra**.

---

## âš™ï¸ **InstruÃ§Ãµes TÃ©cnicas Gerais**

### ğŸ§± 1ï¸âƒ£ Estrutura e Modelagem

Crie (ou ajuste) as seguintes tabelas no banco de dados (SQLAlchemy):

#### ğŸ”¹ `solicitacoes_compra` *(jÃ¡ existente, nÃ£o recriar)*
Deve conter, no mÃ­nimo:
```python
id, fornecedor_id, comprador_id, data_criacao, status, observacoes, valor_total

ğŸ”¹ ordens_compra

Nova tabela vinculada Ã  SC:

id = db.Column(db.Integer, primary_key=True)
sc_id = db.Column(db.Integer, db.ForeignKey('solicitacoes_compra.id'))
fornecedor_id = db.Column(db.Integer, db.ForeignKey('fornecedores.id'))
valor_total = db.Column(db.Float)
status = db.Column(db.String(50))  # Ex: 'Em anÃ¡lise', 'Aprovada', 'Rejeitada', 'Cancelada'
aprovado_por = db.Column(db.Integer, db.ForeignKey('usuarios.id'))
aprovado_em = db.Column(db.DateTime)
observacao = db.Column(db.Text)
ip_aprovacao = db.Column(db.String(50))
gps_aprovacao = db.Column(db.String(100))
device_info = db.Column(db.String(100))
criado_em = db.Column(db.DateTime, default=datetime.utcnow)

ğŸ”¹ auditoria_oc

Tabela de logs:

id, oc_id, usuario_id, acao, data, ip, gps, dispositivo

ğŸ”¹ 2ï¸âƒ£ Backend (Flask)

Crie um novo blueprint chamado compras_bp com rotas dedicadas a OCs:

@app.route('/ordens_compra', methods=['GET'])
@login_required
def listar_ocs():
    # Retorna todas as OCs visÃ­veis ao usuÃ¡rio, com base no perfil
    # Administrador e Financeiro veem todas, Comprador sÃ³ as suas

@app.route('/oc/criar/<int:sc_id>', methods=['POST'])
@login_required
def criar_oc(sc_id):
    # Converte uma SC aprovada em OC
    # Calcula valor total e cria o registro em ordens_compra

@app.route('/oc/aprovar/<int:oc_id>', methods=['PATCH'])
@login_required
def aprovar_oc(oc_id):
    # Altera status para 'Aprovada', registra aprovador, IP, GPS, device

@app.route('/oc/reprovar/<int:oc_id>', methods=['PATCH'])
@login_required
def reprovar_oc(oc_id):
    # Define status como 'Rejeitada' e grava observaÃ§Ã£o


Cada endpoint deve:

Verificar permissÃµes com base no perfil do usuÃ¡rio logado (RBAC).

Administrador e Financeiro podem aprovar/reprovar.

Comprador PJ pode visualizar suas SCs e OCs, mas nÃ£o aprovar.

Registrar logs de auditoria (IP, GPS, data e dispositivo).

Retornar mensagens JSON claras (success: true, message: "...aprovada com sucesso").

ğŸ”¹ 3ï¸âƒ£ Frontend (HTML / Jinja / JS)

Ajuste o template /solicitacoes.html:

Corrigir erros existentes de renderizaÃ§Ã£o ou loop de SCs.

Adicionar coluna â€œAÃ§Ãµesâ€ na tabela de solicitaÃ§Ãµes:

Exibir botÃ£o â€œGerar OCâ€ quando a SC estiver aprovada.

Exibir botÃ£o â€œVer OCâ€ quando jÃ¡ houver uma OC gerada.

Criar modal para aprovaÃ§Ã£o de OCs:

Campos: ObservaÃ§Ãµes (opcional), GPS automÃ¡tico e dispositivo.

BotÃµes: âœ… Aprovar / âŒ Reprovar.

Status colorido (verde = aprovada, vermelho = rejeitada, cinza = em anÃ¡lise).

Adicionar tabela â€œOrdens de Compraâ€

Campos: NÂº, Fornecedor, Valor, Status, Aprovador, Data.

Filtro por status.

BotÃµes de aÃ§Ã£o (Visualizar / Aprovar / Reprovar).

ğŸ”¹ 4ï¸âƒ£ Regras de NegÃ³cio

A OC sÃ³ pode ser criada se a SC estiver com status â€œAprovadaâ€.

SC â†’ OC Ã© uma relaÃ§Ã£o 1:1.

Valores acima do limite configurado (ex: R$ 10.000) exigem aprovaÃ§Ã£o do perfil Financeiro.

Todo evento (criaÃ§Ã£o, aprovaÃ§Ã£o, reprovaÃ§Ã£o) gera log em auditoria_oc.

Logs devem exibir IP, GPS e device capturados do frontend.

ğŸ”¹ 5ï¸âƒ£ Interface e UX

Use cores de status consistentes com o restante do sistema MRX:

Verde: aprovado âœ…

Vermelho: rejeitado âŒ

Amarelo: em anÃ¡lise ğŸ•“

Mantenha design igual ao formulÃ¡rio de SolicitaÃ§Ã£o de Compra (padrÃ£o MRX).

Exibir resumo totalizador:

Total de OCs, em anÃ¡lise, aprovadas e rejeitadas.

ğŸ§© CritÃ©rios de Aceite

âœ… Gerar OC a partir de SC aprovada.
âœ… Aprovar / Reprovar com logs e rastreabilidade.
âœ… Atualizar status visual em /solicitacoes.html.
âœ… Corrigir erros existentes da tela e adicionar tabela de OCs.
âœ… Implementar controle de acesso (Administrador / Financeiro).