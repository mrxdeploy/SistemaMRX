PROMPT COMPLETO: REFORMULA√á√ÉO DO M√ìDULO COMPRADOR - SISTEMA MRX
CONTEXTO ATUAL
O sistema MRX j√° possui:

‚úÖ MaterialBase (app/models.py) - Tabela de materiais com:

codigo, nome, classificacao (leve/medio/pesado)
Vinculado a TabelaPrecoItem para pre√ßos por estrelas
‚úÖ TabelaPreco - 3 tabelas fixas (1‚òÖ, 2‚òÖ, 3‚òÖ)

‚úÖ Fornecedor com tabela_preco_id - V√≠nculo fornecedor ‚Üí tabela

‚úÖ SolicitacaoAutorizacaoPreco - Sistema de aprova√ß√£o de pre√ßos acima da tabela

PROBLEMA IDENTIFICADO
‚ùå O fluxo atual de cria√ß√£o de solicita√ß√µes usa TipoLote ao inv√©s de MaterialBase
‚ùå O cadastro de fornecedor n√£o captura geolocaliza√ß√£o automaticamente
‚ùå Falta wizard de compra em campo com scanner de materiais

OBJETIVO
Reformular completamente:

Cadastro de Fornecedor em Campo com geolocaliza√ß√£o
Wizard de Nova Compra usando MaterialBase + scanner
Fluxo de Autoriza√ß√£o de Pre√ßo autom√°tico
IMPLEMENTA√á√ÉO DETALHADA
PARTE 1: REFORMULAR CADASTRO DE FORNECEDOR
Arquivo: app/routes/fornecedores.py

Altera√ß√µes necess√°rias:

Adicionar captura de geolocaliza√ß√£o no POST /api/fornecedores
# No endpoint criar_fornecedor(), adicionar:
data = request.get_json()
# Capturar geolocaliza√ß√£o do frontend
latitude = data.get('latitude')
longitude = data.get('longitude')
fornecedor = Fornecedor(
    # ... campos existentes ...
    latitude=latitude,
    longitude=longitude,
    tabela_preco_id=1,  # SEMPRE inicia com tabela 1‚òÖ
    criado_por_id=usuario_id
)
Frontend deve enviar coordenadas
Novo arquivo: app/templates/cadastro-fornecedor-campo.html

Criar tela mobile-first com:

Formul√°rio r√°pido (nome, CPF/CNPJ, telefone, endere√ßo)
Captura autom√°tica de GPS via JavaScript Geolocation API
Valida√ß√£o de CPF/CNPJ
Consulta autom√°tica de endere√ßo por CEP (ViaCEP)
PARTE 2: WIZARD DE NOVA COMPRA
Novo arquivo: app/templates/wizard-compra.html

Estrutura em 5 passos:

PASSO 1: Selecionar/Cadastrar Fornecedor
<div id="passo1">
  <input type="text" id="buscaFornecedor" placeholder="Buscar por nome ou CPF/CNPJ">
  <div id="listaFornecedores"></div>
  <button onclick="abrirCadastroRapido()">‚ûï Cadastrar Novo Fornecedor</button>
</div>
JavaScript:

Busca fornecedores via /api/fornecedores?busca=...
Modal de cadastro r√°pido com geolocaliza√ß√£o
Ao selecionar fornecedor, carrega tabela_preco_id e materiais dispon√≠veis
PASSO 2: Dados de Coleta/Entrega
<div id="passo2">
  <h3>Endere√ßo de Coleta</h3>
  <label>
    <input type="radio" name="endereco" value="padrao" checked>
    Usar endere√ßo padr√£o: <span id="endere√ßoPadrao"></span>
  </label>
  <label>
    <input type="radio" name="endereco" value="outro">
    Informar outro endere√ßo para esta compra
  </label>
  
  <h3>Tipo de Retirada</h3>
  <label>
    <input type="radio" name="tipo_retirada" value="coleta" checked>
    üöõ Coleta (MRX busca)
  </label>
  <label>
    <input type="radio" name="tipo_retirada" value="entrega">
    üì¶ Entrega (Fornecedor traz)
  </label>
</div>
PASSO 3: Leitura de Pe√ßas (PRINCIPAL)
<div id="passo3">
  <h3>Escaneie os Materiais</h3>
  
  <!-- Scanner -->
  <div id="scanner">
    <input type="text" id="codigoScanner" placeholder="Escaneie ou digite o c√≥digo">
    <button onclick="buscarMaterial()">üîç Buscar</button>
  </div>
  
  <!-- Resultado da busca -->
  <div id="materialEncontrado" style="display:none">
    <h4>Material: <span id="nomeMaterial"></span></h4>
    <p>C√≥digo: <span id="codigoMaterial"></span></p>
    <p>Classifica√ß√£o: <span id="classificacaoMaterial"></span></p>
    
    <label>Peso (kg):
      <input type="number" id="pesoMaterial" step="0.01" min="0.01">
    </label>
    
    <button onclick="adicionarItem()">‚ûï Adicionar</button>
  </div>
  
  <!-- Lista de itens adicionados -->
  <table id="tabelaItens">
    <thead>
      <tr>
        <th>Material</th>
        <th>Classifica√ß√£o</th>
        <th>Peso (kg)</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="listaItens"></tbody>
  </table>
  
  <!-- Resumo parcial -->
  <div class="resumo-parcial">
    <p>Total de itens: <strong id="totalItens">0</strong></p>
    <p>Peso total: <strong id="pesoTotal">0.00</strong> kg</p>
  </div>
</div>
JavaScript (buscarMaterial()):

async function buscarMaterial() {
  const codigo = document.getElementById('codigoScanner').value;
  
  // Buscar material via API
  const response = await fetch(`/api/materiais-base?codigo=${codigo}`);
  const material = await response.json();
  
  if (material) {
    // Preencher dados do material encontrado
    document.getElementById('nomeMaterial').textContent = material.nome;
    document.getElementById('codigoMaterial').textContent = material.codigo;
    document.getElementById('classificacaoMaterial').textContent = material.classificacao;
    
    // Mostrar se√ß√£o de peso
    document.getElementById('materialEncontrado').style.display = 'block';
    materialAtual = material;
  } else {
    alert('Material n√£o encontrado. Cadastre-o primeiro.');
  }
}
Nova rota necess√°ria:

Arquivo: app/routes/materiais_base.py

@bp.route('', methods=['GET'])
@jwt_required()
def listar_materiais():
    """Lista materiais com filtro por c√≥digo ou nome"""
    busca = request.args.get('busca', '')
    codigo = request.args.get('codigo', '')
    
    query = MaterialBase.query.filter_by(ativo=True)
    
    if codigo:
        query = query.filter_by(codigo=codigo)
    elif busca:
        query = query.filter(
            db.or_(
                MaterialBase.nome.ilike(f'%{busca}%'),
                MaterialBase.codigo.ilike(f'%{busca}%')
            )
        )
    
    materiais = query.all()
    return jsonify([m.to_dict() for m in materiais]), 200
PASSO 4: Valores e Valida√ß√£o de Tabela
<div id="passo4">
  <h3>Pre√ßos Negociados</h3>
  
  <div class="info-tabela">
    <p>Fornecedor est√° vinculado √† tabela: 
      <strong id="tabelaFornecedor"></strong>
    </p>
  </div>
  
  <table id="tabelaPrecos">
    <thead>
      <tr>
        <th>Material</th>
        <th>Classifica√ß√£o</th>
        <th>Peso (kg)</th>
        <th>Pre√ßo Tabela (R$/kg)</th>
        <th>Pre√ßo Negociado (R$/kg)</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="precosItens"></tbody>
  </table>
  
  <div id="alertaAutorizacao" class="alert alert-warning" style="display:none">
    ‚ö†Ô∏è Alguns itens est√£o acima do pre√ßo de tabela e precisar√£o de aprova√ß√£o do ADM.
  </div>
</div>
JavaScript (validarPrecos()):

async function validarPrecos() {
  const fornecedor = fornecedorSelecionado;
  const tabelaId = fornecedor.tabela_preco_id;
  
  // Buscar pre√ßos da tabela
  const response = await fetch(`/api/tabelas-preco/${tabelaId}/precos`);
  const precos = await response.json();
  
  let precisaAutorizacao = false;
  
  itensCompra.forEach(item => {
    // Encontrar pre√ßo do material na tabela
    const precoTabela = precos.find(p => 
      p.material_id === item.material_id
    );
    
    item.preco_tabela = precoTabela.preco_por_kg;
    
    // Comprar pre√ßo negociado com tabela
    if (item.preco_negociado > item.preco_tabela) {
      item.precisaAutorizacao = true;
      precisaAutorizacao = true;
    } else {
      item.precisaAutorizacao = false;
    }
  });
  
  if (precisaAutorizacao) {
    document.getElementById('alertaAutorizacao').style.display = 'block';
  }
}
PASSO 5: Resumo e Confirma√ß√£o
<div id="passo5">
  <h3>Resumo da Compra</h3>
  
  <div class="resumo-compra">
    <p><strong>Fornecedor:</strong> <span id="resumoFornecedor"></span></p>
    <p><strong>Tabela:</strong> <span id="resumoTabela"></span></p>
    <p><strong>Tipo:</strong> <span id="resumoTipo"></span></p>
    
    <table>
      <thead>
        <tr>
          <th>Material</th>
          <th>Peso (kg)</th>
          <th>Pre√ßo (R$/kg)</th>
          <th>Valor Total</th>
        </tr>
      </thead>
      <tbody id="resumoItens"></tbody>
    </table>
    
    <p class="total"><strong>VALOR TOTAL: R$ <span id="valorTotal">0.00</span></strong></p>
  </div>
  
  <button class="btn btn-success" onclick="finalizarCompra()">
    ‚úÖ Confirmar e Gerar Solicita√ß√£o
  </button>
</div>
PARTE 3: REFORMULAR BACKEND DE SOLICITA√á√ïES
Arquivo: app/routes/solicitacoes_new.py

Modificar endpoint POST /api/solicitacoes:

@bp.route('', methods=['POST'])
@jwt_required()
def criar_solicitacao():
    try:
        usuario_id = int(get_jwt_identity())
        data = request.get_json()
        
        # Valida√ß√µes b√°sicas
        if not data.get('fornecedor_id'):
            return jsonify({'erro': 'Fornecedor √© obrigat√≥rio'}), 400
        
        if not data.get('itens') or len(data['itens']) == 0:
            return jsonify({'erro': 'Adicione pelo menos um item'}), 400
        
        fornecedor = Fornecedor.query.get(data['fornecedor_id'])
        if not fornecedor or not fornecedor.tabela_preco_id:
            return jsonify({'erro': 'Fornecedor inv√°lido ou sem tabela vinculada'}), 400
        
        # Criar solicita√ß√£o
        solicitacao = Solicitacao(
            funcionario_id=usuario_id,
            fornecedor_id=data['fornecedor_id'],
            tipo_retirada=data.get('tipo_retirada', 'buscar'),
            observacoes=data.get('observacoes', ''),
            status='pendente'
        )
        
        db.session.add(solicitacao)
        db.session.flush()
        
        # Vari√°veis de controle
        precisa_autorizacao = False
        itens_acima_tabela = []
        
        # Processar itens
        for item_data in data['itens']:
            material_id = item_data.get('material_id')
            peso_kg = float(item_data.get('peso_kg', 0))
            preco_negociado = float(item_data.get('preco_negociado', 0))
            
            # Buscar material
            material = MaterialBase.query.get(material_id)
            if not material:
                continue
            
            # Buscar pre√ßo da tabela do fornecedor
            preco_item = TabelaPrecoItem.query.filter_by(
                tabela_preco_id=fornecedor.tabela_preco_id,
                material_id=material_id
            ).first()
            
            if not preco_item:
                return jsonify({
                    'erro': f'Pre√ßo n√£o configurado para {material.nome}'
                }), 400
            
            preco_tabela = float(preco_item.preco_por_kg)
            
            # VALIDA√á√ÉO: pre√ßo negociado vs tabela
            if preco_negociado > preco_tabela:
                precisa_autorizacao = True
                itens_acima_tabela.append({
                    'material': material.nome,
                    'preco_tabela': preco_tabela,
                    'preco_negociado': preco_negociado,
                    'peso_kg': peso_kg
                })
            
            # Calcular valor
            valor_calculado = peso_kg * preco_negociado
            
            # Criar item da solicita√ß√£o
            item = ItemSolicitacao(
                solicitacao_id=solicitacao.id,
                material_id=material_id,  # USAR MaterialBase
                peso_kg=peso_kg,
                classificacao=material.classificacao,
                valor_calculado=valor_calculado,
                preco_por_kg_snapshot=preco_negociado,
                observacoes=item_data.get('observacoes', '')
            )
            
            db.session.add(item)
        
        # Se precisa autoriza√ß√£o, criar solicita√ß√µes
        if precisa_autorizacao:
            for item_info in itens_acima_tabela:
                autorizacao = SolicitacaoAutorizacaoPreco(
                    fornecedor_id=fornecedor.id,
                    comprador_id=usuario_id,
                    material_id=item_info['material_id'],
                    peso_kg=item_info['peso_kg'],
                    tabela_atual_id=fornecedor.tabela_preco_id,
                    preco_tabela=item_info['preco_tabela'],
                    preco_negociado=item_info['preco_negociado'],
                    justificativa=data.get('justificativa', 'Negocia√ß√£o em campo'),
                    status='pendente'
                )
                db.session.add(autorizacao)
            
            # Marcar solicita√ß√£o como aguardando autoriza√ß√£o
            solicitacao.status = 'aguardando_autorizacao'
            
            # Notificar ADM
            notificar_adm_autorizacao_pendente(solicitacao.id)
        
        db.session.commit()
        
        return jsonify({
            'mensagem': 'Solicita√ß√£o criada com sucesso',
            'solicitacao': solicitacao.to_dict(),
            'precisa_autorizacao': precisa_autorizacao,
            'itens_acima_tabela': len(itens_acima_tabela)
        }), 201
    
    except Exception as e:
        db.session.rollback()
        return jsonify({'erro': str(e)}), 500
PARTE 4: AJUSTAR MODELO ItemSolicitacao
Arquivo: app/models.py

Adicionar campo material_id:

class ItemSolicitacao(db.Model):
    # ... campos existentes ...
    
    # ADICIONAR:
    material_id = db.Column(db.Integer, db.ForeignKey('materiais_base.id'), nullable=True)
    
    # Relationships
    material = db.relationship('MaterialBase', backref='itens_solicitacao')
Migration SQL:

ALTER TABLE itens_solicitacao ADD COLUMN material_id INTEGER REFERENCES materiais_base(id);
PARTE 5: TELA DE AUTORIZA√á√ïES ADM
Arquivo: app/templates/autorizacoes-preco.html

J√° existe, mas adicionar filtros e a√ß√µes:

<div class="filtros">
  <select id="filtroStatus">
    <option value="">Todos</option>
    <option value="pendente" selected>Pendentes</option>
    <option value="aprovada">Aprovadas</option>
    <option value="rejeitada">Rejeitadas</option>
  </select>
</div>
<table>
  <thead>
    <tr>
      <th>Data</th>
      <th>Comprador</th>
      <th>Fornecedor</th>
      <th>Material</th>
      <th>Peso (kg)</th>
      <th>Pre√ßo Tabela</th>
      <th>Pre√ßo Negociado</th>
      <th>Diferen√ßa %</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody id="listaAutorizacoes"></tbody>
</table>
Modal de aprova√ß√£o:

<div class="modal" id="modalAprovar">
  <h3>Aprovar Compra</h3>
  
  <label>
    <input type="checkbox" id="promoverFornecedor">
    Promover fornecedor para tabela superior
  </label>
  
  <select id="novaTabelaId" disabled>
    <option value="2">2 Estrelas</option>
    <option value="3">3 Estrelas</option>
  </select>
  
  <button onclick="aprovarAutorizacao()">‚úÖ Aprovar</button>
</div>
RESUMO DAS ALTERA√á√ïES
Arquivos Novos:
app/templates/cadastro-fornecedor-campo.html
app/templates/wizard-compra.html
Arquivos Modificados:
app/routes/fornecedores.py - Adicionar geolocaliza√ß√£o
app/routes/solicitacoes_new.py - Usar MaterialBase + autoriza√ß√£o autom√°tica
app/routes/materiais_base.py - Endpoint de busca
app/models.py - Adicionar material_id em ItemSolicitacao
Migration SQL:
ALTER TABLE itens_solicitacao ADD COLUMN material_id INTEGER REFERENCES materiais_base(id);
FLUXO COMPLETO IMPLEMENTADO
Comprador em campo ‚Üí Abre wizard
Seleciona/cadastra fornecedor ‚Üí GPS autom√°tico
Escaneia materiais ‚Üí Busca MaterialBase
Informa pesos e pre√ßos ‚Üí Compara√ß√£o autom√°tica com tabela
Se pre√ßo > tabela ‚Üí Gera SolicitacaoAutorizacaoPreco
ADM aprova ‚Üí Pode promover fornecedor (1‚òÖ‚Üí2‚òÖ‚Üí3‚òÖ)
Solicita√ß√£o aprovada ‚Üí Gera OC e Lote